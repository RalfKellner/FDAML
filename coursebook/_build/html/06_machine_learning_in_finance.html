
<!DOCTYPE html>


<html lang="en" data-content_root="./" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Machine learning in finance &#8212; Financial Data Analytics and Machine Learning</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="_static/styles/sphinx-book-theme.css?v=384b581d" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css?v=13237357" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.4510f1fc1dee50b3e5859aac5469c37c29e427902b24a333a5f9fcb2f0b3ac41.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css?v=4fa983c6" />
    <link rel="stylesheet" type="text/css" href="_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="_static/documentation_options.js?v=9eb32ce0"></script>
    <script src="_static/doctools.js?v=9a2dae69"></script>
    <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="_static/copybutton.js?v=f281be69"></script>
    <script src="_static/scripts/sphinx-book-theme.js?v=efea14e4"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="_static/togglebutton.js?v=4a39c7ea"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script src="_static/design-tabs.js?v=36754332"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script async="async" src="_static/sphinx-thebe.js?v=c100c467"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown';</script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"; const thebe_selector = ".thebe,.cell"; const thebe_selector_input = "pre"; const thebe_selector_output = ".output, .cell_output"</script>
    <script>window.MathJax = {"options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = '06_machine_learning_in_finance';</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Machine learning" href="05_machine_learning.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search this book..."
         aria-label="Search this book..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">

  

<a class="navbar-brand logo" href="00_welcome.html">
  
  
  
  
  
  
    <p class="title logo__title">Financial Data Analytics and Machine Learning</p>
  
</a></div>
        <div class="sidebar-primary-item">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script></div>
        <div class="sidebar-primary-item"><nav class="bd-links bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="00_welcome.html">
                    Introduction
                </a>
            </li>
        </ul>
        <ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="01_introduction.html">Financial markets</a></li>
<li class="toctree-l1"><a class="reference internal" href="02_empirical_asset_returns.html">Empirical analysis of asset returns</a></li>
<li class="toctree-l1"><a class="reference internal" href="03_univariate_models.html">Modeling univariate asset return distributions</a></li>
<li class="toctree-l1"><a class="reference internal" href="04_dependence_matters.html">Multivariate analysis - dependence matters!</a></li>
<li class="toctree-l1"><a class="reference internal" href="05_machine_learning.html">Machine learning</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Machine learning in finance</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">


<a href="https://github.com/executablebooks/jupyter-book" target="_blank"
   class="btn btn-sm btn-source-repository-button"
   title="Source repository"
   data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fab fa-github"></i>
  </span>

</a>






<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="_sources/06_machine_learning_in_finance.ipynb" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.ipynb</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>



<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>Machine learning in finance</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prediction-of-asset-risk-premiums">Prediction of asset risk premiums</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#specifics">Specifics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#building-your-own-machine-learning-models-for-asset-price-prediction">Building your own machine learning models for asset price prediction</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-and-using-pca-loadings-for-asset-return-data">Understanding and using PCA loadings for asset return data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cluster-portfolios-by-pca-loadings">Cluster portfolios by pca loadings</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cluster-portfolios-by-fama-french-factor-exposure">Cluster portfolios by Fama-French factor exposure</a></li>
</ul>
</li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section class="tex2jax_ignore mathjax_ignore" id="machine-learning-in-finance">
<h1>Machine learning in finance<a class="headerlink" href="#machine-learning-in-finance" title="Link to this heading">#</a></h1>
<p>Traditionally, machine learning as defined in the previous chapter did not play a major role in the field of financial markets. To a certain extent, this may be related due to the large fraction of noise which often comes along with financial data. Noise refers to randomness in this context and generates large challenges for machine learning algorithms to find consistent patterns and relationships in data sets.</p>
<p>However, with the increasing popularity of machine learning algorithms and their increasing availability in terms of computational power and access to algorithms, more and more applications of these algorithms in popular fields of finance are found by researchers. Thus, we are going to examine a few applications towards the end of this book which demonstrate successful applications of machine learning algorithm in the financial area.</p>
<section id="prediction-of-asset-risk-premiums">
<h2>Prediction of asset risk premiums<a class="headerlink" href="#prediction-of-asset-risk-premiums" title="Link to this heading">#</a></h2>
<p>An obvious desire of financial market participants is to identify patterns which may predict future asset prices. However, this task is very challenging due to the efficiency of financial markets which has been formalized by Eugene Fama in the 1960s under the notation of the <em>market efficiency hypothesis</em>. According to it, asset prices fully reflect all available information at any given time. The hypothesis comes in three forms: weak, semi-strong, and strong.</p>
<ol class="arabic simple">
<li><p>Weak Form Efficiency: This form asserts that all past trading information, such as historical prices and volumes, is already incorporated into asset prices. Therefore, technical analysis or trading based on past price movements should not consistently yield excess returns.</p></li>
<li><p>Semi-Strong Form Efficiency: This form suggests that all publicly available information is already reflected in asset prices. Consequently, fundamental analysis, which involves evaluating public information like financial statements and news releases, should not consistently result in excess returns.</p></li>
<li><p>Strong Form Efficiency: The strongest form posits that all information, both public and private (inside information), is fully reflected in stock prices. As a result, even insiders with privileged information cannot consistently achieve higher returns than the market.</p></li>
</ol>
<p>If markets are efficient, information which impacts the price of an asset is immediately processed which results in an instant price adjustment. Future information from the current point of view in time is random, thus, all future price changes are random which makes it impossible to predict them.</p>
<p>However, empirical studies in asset pricing have identified several factors that seem to predict excess returns, contradicting the notion of market efficiency, particularly in its semi-strong and strong forms. These factors include:</p>
<ol class="arabic simple">
<li><p>Size (Small-Cap Effect): Empirical evidence suggests that small-cap stocks tend to outperform large-cap stocks on a risk-adjusted basis. This is known as the size effect or small-cap premium.</p></li>
<li><p>Value (Book-to-Market Ratio): Stocks with high book-to-market ratios (value stocks) tend to outperform those with low ratios (growth stocks).</p></li>
<li><p>Momentum: Stocks that have performed well in the past tend to continue performing well in the short-term future.</p></li>
<li><p>Liquidity: Less liquid stocks tend to have higher expected returns to compensate for their higher transaction costs and trading difficulties.</p></li>
</ol>
<p>The predictive power of these factors raises questions about the validity of the market efficiency hypothesis. However, several arguments and theories attempt to reconcile these empirical findings with market efficiency:</p>
<ol class="arabic simple">
<li><p>Risk-Based Explanations: Proponents of market efficiency argue that these factors may be proxies for risk that is not captured by traditional models like the Capital Asset Pricing Model (CAPM). For example, small-cap stocks may be riskier, and their higher returns are compensation for this additional risk.</p></li>
<li><p>Behavioral Finance: Behavioral finance scholars argue that cognitive biases and irrational behavior among investors can lead to predictable patterns in stock returns, challenging the notion of fully efficient markets.</p></li>
<li><p>Market Inefficiencies: Some degree of inefficiency may exist due to limits to arbitrage, transaction costs, and information asymmetry, allowing for the possibility of abnormal returns based on certain predictive variables.</p></li>
</ol>
<p>So let us take a look at the prediction of asset returns as presented in the paper by <a class="reference external" href="https://dachxiu.chicagobooth.edu/download/ML.pdf">Gu et al. (2018)</a> which conduct a large empirical study that aims to predict excess returns (which is the return minus the risk free rate). The authors utilize various machine learning methods, including tree-based algorithms like random forests and gradient boosting, penalized linear models such as LASSO and ridge regression, and neural networks. These methods are compared against traditional linear models to assess their effectiveness in asset pricing. The study uses a comprehensive dataset covering a wide range of stock characteristics and macroeconomic variables, including 94 characteristics for individual stocks to capture the multidimensional nature of asset returns.</p>
<p>Performance metrics for the models include out-of-sample R-squared values and mean squared prediction errors. Additionally, the economic significance of the predictions is evaluated by constructing portfolios based on the predicted returns. The findings indicate that machine learning models significantly outperform traditional linear models in predicting asset returns. Nonlinear models, particularly tree-based methods and neural networks, show substantial improvements in capturing complex interactions among variables. This enhanced predictive power translates into economically significant gains when applied to portfolio construction.</p>
<p>The study suggests that machine learning can uncover patterns and relationships in financial data that traditional approaches might miss. This has implications for both academic research and practical investment strategies, indicating the potential for machine learning to improve the understanding and forecasting of asset returns. The authors conclude that machine learning offers a valuable toolkit for empirical asset pricing and advocate for its broader adoption in financial research. They emphasize the need for ongoing innovation in modeling approaches to keep pace with the increasing complexity of financial markets.</p>
<section id="specifics">
<h3>Specifics<a class="headerlink" href="#specifics" title="Link to this heading">#</a></h3>
<p>In the paper, the target variable is the next month excess return <span class="math notranslate nohighlight">\(r_{i, t+1}\)</span> (return minus a risk free rate - usually a treasurey bill rate is used). We assume that this return follows a process like:</p>
<div class="math notranslate nohighlight">
\[
r_{i, t+1} = E_t \left( r_{i, t+1} | \mathbf{z}_{i, t} \right) + \epsilon_{i, t}
\]</div>
<p>which is called an additive prediction error model where <span class="math notranslate nohighlight">\(i\)</span> is the index for a company and <span class="math notranslate nohighlight">\(t\)</span> denotes the point in time. Available information of feature variables <span class="math notranslate nohighlight">\(\mathbf{z}_{i, t}\)</span> are given at time <span class="math notranslate nohighlight">\(t\)</span> such that <span class="math notranslate nohighlight">\(E_t \left( r_{i, t+1} | \mathbf{z}_{i, t} \right)\)</span> is the conditional expected value for the next month, given this information. The assumption is that the conditional expectation has some functional form which depends on <span class="math notranslate nohighlight">\(\mathbf{z}_{i, t}\)</span>. To approximate this functional relationship, different machine learning models can be used. The paper compares a multitude of different algorithms for this purpose such as a linear regression model (as a benchmark) with and without regularization techniques, support vector machines, boosted regression trees and forests and neural networks.</p>
<p>The data is split into training, validation and testing samples while the authors follow the cumulative window approach as describe in the last chapter. I.e., the model is retrained every year, hyperparameters are tuned using a fixed length of validation period and predictions are made for the next year. The more recent the time period gets, the longer the training sample.</p>
<p>The data consists of American firms listed at the NYSE, AMEX and NASDAQ and starts in the year 1957 while ending in 2016. The first split starts with the first 18 years of the data set, 12 years following are used for validation and the next year is predicted. The cumulative window finally results in 30 years of test data (with 47 years of training data for the last year).</p>
<p>Feature variables are given by 94 firm characteristics, 74 industry dummies, eight macroeconomic variables, as well as interactions between firm characteristics and macro variables, resulting in 920 variables per company and point in time. Stock characteristics are ranked cross-sectionally at every period and transformed to the interval [-1, 1].</p>
<p>The evaluation metric used is an adjusted out of sample version for the coefficient of determination. Two crucial differences are made in comparison to the common coefficient of determination: (1) it is derived for out-of-sample predictions, only, and (2) it compares predictions to a default prediction for the monthly return to be zero (instead of using the average of monthly returns from the training period). The latter is in line with a random walk theory which states that the best prediction for the next point in time is today’s value. The formula is given by:</p>
<div class="math notranslate nohighlight">
\[
R_{oos}^2 = 1 - \frac{\sum_{(i, t) \in \Tau_{3}} \left(r_{i, t+1} - \hat{r}_{i, t+1} \right)^2}{\sum_{(i, t) \in \Tau_{3}} r_{i, t+1} ^2}
\]</div>
<p>While at first sight, this may seem as a “hack” to improve results, this is done because a forecast for the monthly return of being zero usually is better than historical averages of returns.</p>
</section>
<section id="results">
<h3>Results<a class="headerlink" href="#results" title="Link to this heading">#</a></h3>
<p>Among the different algorithms, neural networks result in the best predictions with values of <span class="math notranslate nohighlight">\(R_{oos}^2\)</span> in the range <span class="math notranslate nohighlight">\([0.0033, 0.0040]\)</span>. These values may seem incredibly low, however, in the financial domain this is rather strong as usually it is almost impossible to predict future asset price movements on an individual level.</p>
<p>A common way to examine predictive power of firm characteristics in the financial literature is to sort companies in the cross-section. This means at a fixed point in time, companies are ranked according to one or more variables. One fictionally holds portfolios with the companies exhibiting the highest and lowest ranks, e.g., the top and least quintiles serve as thresholds to choose for portfolios. If a statistical difference in the future performance of these portfolios is found, the variable which is used for sorting has predictive power of future asset price movements. However, this is an aggregated point of view which likely reduces the level of noise in the future development of individual asset price development.</p>
<p>Among the features which are most important for making good predictions, we find</p>
<ul class="simple">
<li><p>the one-month momentum which is the monthly return from the previous month</p></li>
<li><p>the size which is represented by the market value of a company</p></li>
<li><p>idiosyncratic volatility relative to the Fama French three factor model</p></li>
<li><p>the six month change in momentum which is the difference of returns with a time lag of 6 months</p></li>
<li><p>the maximum daily returns of the past month</p></li>
<li><p>dollar trading volume which is a proxy for liquidity and is calculated as the close price times the volume of a stock</p></li>
</ul>
<p>All of these variables have been found in previous studies to be predictive if used for building portfolios. Furthermore, all of these variables can be determined by asset price data (open, high, low, close and volume data) with the exception of the market value. The latter is not easily accessible historically and needs to be gathered from (usually costly) data providers.</p>
<p>The study further shows how to predict monthly returns on portfolio level by a bottom-up prediction approach. Given multiple assets <span class="math notranslate nohighlight">\(i = 1, ..., n\)</span> which are held by an investor with weights <span class="math notranslate nohighlight">\(w_i\)</span>, the monthly portfolio return is predicted by:</p>
<div class="math notranslate nohighlight">
\[
\hat{r}_{i, t+1}^p = \sum_i w_i \hat{r}_{i, t+1}
\]</div>
<p>The paper finds that predictions on portfolio level are also promising and reach a little higher values for <span class="math notranslate nohighlight">\(R_{oos}^2\)</span> in comparison to individual predictions. Finally, the paper uses individual predictions to build portfolios by buying companies with the most promising predictions for the next month and short selling companies with the least promising predictions. More concrete, a ranking is made at every month which ranks all companies’ next month return prediction. The top decile (companies with predictions that belong to the top 10% predictions) portfolio is hold in a long position and the low decile portfolio is short sold. Again, portfolios which are build using neural network predictions result in the higest Sharpe ratios</p>
</section>
<section id="building-your-own-machine-learning-models-for-asset-price-prediction">
<h3>Building your own machine learning models for asset price prediction<a class="headerlink" href="#building-your-own-machine-learning-models-for-asset-price-prediction" title="Link to this heading">#</a></h3>
<p>Even the paper successfully demonstrates a reasonable application of machine learning algorithms in the domain of asset price prediction, it is challenging to build a model by yourself. One large limitation is access to data, especially historical data with a long history which also includes companies that do not exist anymore. Furthermore, data besides typical price data (OHLC and volume) is often not freely available. Nevertheless, let us take a look at what we can do.</p>
<p>Among the most important variables for feature prediction, all can be calculated, except for the size variable. Furthermore, we can examine the data if differences in future performance can be identified, given we select companies according to the differences in the variable.</p>
<p>In the code below, we use data which has been collected with a starting data at January 2015 and includes companies which are today in the S&amp;P 500 or have been removed from it in the past. Moreover, as this likely includes mostly successful and large companies we further collect data of companies of the New York Stock Exchange randomly. Hereby, we select 300 delisted and 200 active companies.</p>
<p>For this data, we determine the monthly return as the one-month momentum is the most important variable w.r.t prediction of asset prices (at least the most important of the empirical study by Gu et. al, 2018). We follow the traditional momentum trading strategy which fictionally buys the top 10% performing stocks from the past month and short sells the top 10% losers. The original identification of momentum effects goes back to a paper by <a class="reference external" href="https://www.bauer.uh.edu/rsusmel/phd/jegadeesh-titman93.pdf">Jedageesh and Titman, 1993</a> who find that following these types of strategies create(d) abnormal returns.</p>
<p>If this is true, that portfolios which are build based upon momentum create different results over time, then momentum can be useful for individual asset return prediction. For our data set, we find a result which is the opposite of the original findings, however, there seems to be a difference. Below, you can observe that the losers portfolio (if stocks would be bought if they perform poorly in the previous month) exhibits a different cumulative portfolio return thant the winners portfolio. Nevertheless, including the one-month momentum may be promising for prediction, the the relation holds for individual companies, a high current return may indicate a lower return in the next month.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;../studies/assetprice_prediction/sp500.sqlite&quot;</span><span class="p">)</span>
<span class="n">sp500_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM stock_data&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
<span class="n">sp500_data_add</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM stock_data_additional_nyse&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>

<span class="n">sp500_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">sp500_data</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
<span class="n">sp500_data</span> <span class="o">=</span> <span class="n">sp500_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span>

<span class="n">sp500_data_add</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">sp500_data_add</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
<span class="n">sp500_data_add</span> <span class="o">=</span> <span class="n">sp500_data_add</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span>

<span class="n">duplicated_tickers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sp500_data</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sp500_data_add</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">unique</span><span class="p">())))</span>
<span class="n">sp500_data_add</span> <span class="o">=</span> <span class="n">sp500_data_add</span><span class="p">[</span><span class="o">~</span><span class="n">sp500_data_add</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">duplicated_tickers</span><span class="p">)]</span>

<span class="n">study_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">sp500_data</span><span class="p">,</span> <span class="n">sp500_data_add</span><span class="p">))</span>
<span class="n">study_data</span> <span class="o">=</span> <span class="n">study_data</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>

<span class="n">conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

<span class="n">study_data_close</span> <span class="o">=</span> <span class="n">study_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;adjusted_close&quot;</span><span class="p">,</span> <span class="s2">&quot;ticker&quot;</span><span class="p">]]</span>
<span class="n">study_data_close</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">study_data_close_wide</span> <span class="o">=</span> <span class="n">study_data_close</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="s2">&quot;ticker&quot;</span><span class="p">)</span>
<span class="n">study_data_close_wide</span> <span class="o">=</span> <span class="n">study_data_close_wide</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;adjusted_close&quot;</span><span class="p">]</span>
<span class="n">monthly_returns</span> <span class="o">=</span> <span class="n">study_data_close_wide</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;ME&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">last</span><span class="p">()</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">fill_method</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span>

<span class="n">remove_tickers_too_many_na</span> <span class="o">=</span> <span class="n">monthly_returns</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">monthly_returns</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.90</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">monthly_returns</span> <span class="o">=</span> <span class="n">monthly_returns</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">remove_tickers_too_many_na</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">remove_tickers_due_to_outliers</span> <span class="o">=</span> <span class="n">monthly_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[:</span><span class="mi">19</span><span class="p">]</span>
<span class="n">monthly_returns</span> <span class="o">=</span> <span class="n">monthly_returns</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">remove_tickers_due_to_outliers</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">n_assets</span> <span class="o">=</span> <span class="n">monthly_returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">top_n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">n_assets</span><span class="p">)</span>
<span class="n">bottom_n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.1</span> <span class="o">*</span> <span class="n">n_assets</span><span class="p">)</span>

<span class="n">ranked_momentum</span> <span class="o">=</span> <span class="n">monthly_returns</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">winners</span> <span class="o">=</span> <span class="n">ranked_momentum</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">top_n</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">losers</span> <span class="o">=</span> <span class="n">ranked_momentum</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">bottom_n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">winners_returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">winners</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">monthly_returns</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">losers_returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">losers</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">monthly_returns</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">strategy_returns</span> <span class="o">=</span> <span class="p">(</span><span class="n">winners_returns</span> <span class="o">-</span> <span class="n">losers_returns</span><span class="p">)</span><span class="c1">#.mean(axis=1)</span>

<span class="n">cumulative_returns_winners</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">winners_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">cumulative_returns_losers</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">losers_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">cumulative_returns</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strategy_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span>

<span class="c1"># Plotting the cumulative returns</span>
<span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">8</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="n">cumulative_returns_winners</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;winners&quot;</span><span class="p">)</span>
<span class="n">cumulative_returns_losers</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;losers&quot;</span><span class="p">)</span>
<span class="n">cumulative_returns</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">label</span> <span class="o">=</span> <span class="s2">&quot;winners-losers&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Momentum Trading Strategy Cumulative Returns&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="s1">&#39;Date&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s1">&#39;Cumulative Returns&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/03e54032d6f22984bbe121e62b4bb9f79920e0dbb384d8c7218f4fef81ee31e3.png" src="_images/03e54032d6f22984bbe121e62b4bb9f79920e0dbb384d8c7218f4fef81ee31e3.png" />
</div>
</div>
<p>To get a feeling for the potential of the approach by Gu et al. (2018), we aim to mimic their proceeding with a very reduced data set. We calculate monthly values for the variables:</p>
<ul class="simple">
<li><p>the one-month momentum</p></li>
<li><p>idiosyncratic volatility</p></li>
<li><p>the six month change in momentum</p></li>
<li><p>the maximum daily return</p></li>
<li><p>dollar trading volume</p></li>
</ul>
<p>Every month, these values are ranked in the cross-section of companies and ranks are normalized in the range <span class="math notranslate nohighlight">\([-1, 1]\)</span>. We use a rolling window approach and always use the past 36 months to train a neural network for predicting the next month excess return. Hereby, every month is one batch which is used for gradient descent parameter updating. This model is used to make predictions for the next month. After this, we repeat this procedure starting at the next month. The final <span class="math notranslate nohighlight">\(R_{oos}^2\)</span> is determined based upon all out-of-sample predictions.</p>
<p>We train a neural network with up to two hidden layers, including ReLu activation functions. The number of hidden neurons and the learning rate is determined by hyperparameter tuning and results in 50 hidden neurons for the first hidden layer and 30 hidden neurons the the second one. The learning rate is set to <span class="math notranslate nohighlight">\(0.001\)</span>. The final <span class="math notranslate nohighlight">\(R_{oos}^2\)</span> is almost zero, yet, slightly negative. Below you can see the monthly values for the test period. They demonstrate, that our small model with a comparably short history is able to at least create good predictions for almost half of the months in the out of sample period. This is rather promising and may be further improved by including macro-economic or industry variables as the original study.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">oos_r2_values</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;asset_price_predictions.csv&quot;</span><span class="p">)</span>
<span class="n">oos_r2_values</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">oos_r2_values</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
<span class="n">oos_r2_values</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
<span class="n">oos_r2_values</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">legend</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="s2">&quot;Monthly R2 oos&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">0.5</span><span class="p">,</span> <span class="n">linestyle</span> <span class="o">=</span> <span class="s2">&quot;--&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/75b0e63bf7e670b9f65107065602518fb066eb00288c7722e44f0a0242aa5d88.png" src="_images/75b0e63bf7e670b9f65107065602518fb066eb00288c7722e44f0a0242aa5d88.png" />
</div>
</div>
</section>
</section>
<section id="understanding-and-using-pca-loadings-for-asset-return-data">
<h2>Understanding and using PCA loadings for asset return data<a class="headerlink" href="#understanding-and-using-pca-loadings-for-asset-return-data" title="Link to this heading">#</a></h2>
<p>In chapter 5, we learned that PCA builds PCS scores by multiplying the original (normalized) data <span class="math notranslate nohighlight">\(Z\)</span></p>
<div class="math notranslate nohighlight">
\[\begin{split}
Z = 
\begin{pmatrix}
z_{11} &amp; ... &amp; z_{1n} \\
\vdots &amp; \ddots &amp; \vdots \\
x_{T1} &amp; ... &amp; z_{tn} \\
\end{pmatrix}
\end{split}\]</div>
<p>with up to <span class="math notranslate nohighlight">\(k\)</span> principal component vectors <span class="math notranslate nohighlight">\(\mathbf{u}_l, l = 1, ..., k\)</span> which results in a reduced dimensional representation of the data <span class="math notranslate nohighlight">\(V\)</span>. Note that we switched index <span class="math notranslate nohighlight">\(i\)</span> with index <span class="math notranslate nohighlight">\(t\)</span> in comparison to the last chapter as our application will consist of <span class="math notranslate nohighlight">\(T\)</span> observations for <span class="math notranslate nohighlight">\(n\)</span> companies. The columns of <span class="math notranslate nohighlight">\(V\)</span> are principal component scores which are independent and exhibit a decreasing level of variation and level of explained variation for the original data. In detail, each PCA score is determined by building weighted sums of the original data and the PCA vector:</p>
<div class="math notranslate nohighlight">
\[
v_{t1} = z_{t1} u_{1l} + ... + z_{tn} u_{nl}
\]</div>
<p>Realizations <span class="math notranslate nohighlight">\(\mathbf{z}_t\)</span> are either mean centered or standardized. No matter which form of normalization we choose, values for <span class="math notranslate nohighlight">\(z_{tj} &gt; 0\)</span> imply an asset return which is above average for an asset and <span class="math notranslate nohighlight">\(z_{tj} &lt; 0\)</span> implies days with below average value development. For the weighted sum <span class="math notranslate nohighlight">\(v_{t1} &gt; 0\)</span> is a scenario which implies that assets with corresponding loadings <span class="math notranslate nohighlight">\(u_{jl} &gt; 0\)</span> exhibited a better (weighted) performance than the group of assets with loadings <span class="math notranslate nohighlight">\(u_{jl} &lt; 0\)</span>.</p>
<p>We use the same data as before, below you can see the signs of PCA vector loadings for the first five principal components. In our example almost all signs of the first principal components are negative. This makes sense as asset returns of stock market companies usually exhibit positive correlation. Consequently, the first principal component which is able to explain most of the variation in all asset returns rather captures similar developments among all companies. Note that the finding stays the same if all loadings would be positive. If all (or all we consider) are negative, then <span class="math notranslate nohighlight">\(v_{t1} &lt; 0\)</span> implies a weighted (by the absolute loading value) above average development for the majority of all companies.</p>
<p>The higher the loading in absolute values, the greater the impact of a company for the determination of the principal component score. This implies that the company is more important to explain the variation in the data overall and, thus, can be considered to play a more important role for systematic market movements. At the same time, this indicates that the company itself reacts more sensitive to systematic market movements.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>

<span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="s2">&quot;../studies/assetprice_prediction/sp500.sqlite&quot;</span><span class="p">)</span>
<span class="n">sp500_data</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM stock_data&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>
<span class="n">sp500_data_add</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_sql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM stock_data_additional_nyse&quot;</span><span class="p">,</span> <span class="n">conn</span><span class="p">)</span>

<span class="n">sp500_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">sp500_data</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
<span class="n">sp500_data</span> <span class="o">=</span> <span class="n">sp500_data</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span>

<span class="n">sp500_data_add</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;date&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">sp500_data_add</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
<span class="n">sp500_data_add</span> <span class="o">=</span> <span class="n">sp500_data_add</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;date&quot;</span><span class="p">)</span>

<span class="n">duplicated_tickers</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sp500_data</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span><span class="o">.</span><span class="n">intersection</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">sp500_data_add</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">unique</span><span class="p">())))</span>
<span class="n">sp500_data_add</span> <span class="o">=</span> <span class="n">sp500_data_add</span><span class="p">[</span><span class="o">~</span><span class="n">sp500_data_add</span><span class="o">.</span><span class="n">ticker</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">duplicated_tickers</span><span class="p">)]</span>

<span class="n">sp500_wide</span> <span class="o">=</span> <span class="n">sp500_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;adjusted_close&quot;</span><span class="p">,</span> <span class="s2">&quot;ticker&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="s2">&quot;ticker&quot;</span><span class="p">)</span>
<span class="n">sp500_returns</span> <span class="o">=</span> <span class="n">sp500_wide</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">fill_method</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span>
<span class="n">sp500_returns</span> <span class="o">=</span> <span class="n">sp500_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;adjusted_close&quot;</span><span class="p">]</span>

<span class="n">remove_tickers_too_many_na</span> <span class="o">=</span> <span class="n">sp500_returns</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">sp500_returns</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.90</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">sp500_returns</span> <span class="o">=</span> <span class="n">sp500_returns</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">remove_tickers_too_many_na</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">remove_tickers_due_to_outliers</span> <span class="o">=</span> <span class="n">sp500_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[:</span><span class="mi">9</span><span class="p">]</span>
<span class="n">sp500_returns</span> <span class="o">=</span> <span class="n">sp500_returns</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">remove_tickers_due_to_outliers</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">sp500_data_add_wide</span> <span class="o">=</span> <span class="n">sp500_data_add</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;adjusted_close&quot;</span><span class="p">,</span> <span class="s2">&quot;ticker&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">pivot</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="s2">&quot;ticker&quot;</span><span class="p">)</span>
<span class="n">sp500_data_add_wide</span> <span class="o">=</span> <span class="n">sp500_data_add_wide</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">NA</span><span class="p">)</span>
<span class="n">sp500_returns_add</span> <span class="o">=</span> <span class="n">sp500_data_add_wide</span><span class="o">.</span><span class="n">pct_change</span><span class="p">(</span><span class="n">fill_method</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="mi">1</span><span class="p">:,</span> <span class="p">:]</span>
<span class="n">sp500_returns_add</span> <span class="o">=</span> <span class="n">sp500_returns_add</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;adjusted_close&quot;</span><span class="p">]</span>

<span class="n">remove_tickers_too_many_na</span> <span class="o">=</span> <span class="n">sp500_returns_add</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">sp500_returns_add</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mf">0.90</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">sp500_returns_add</span> <span class="o">=</span> <span class="n">sp500_returns_add</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">remove_tickers_too_many_na</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">remove_tickers_due_to_outliers</span> <span class="o">=</span> <span class="n">sp500_returns_add</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="n">ascending</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()[:</span><span class="mi">9</span><span class="p">]</span>
<span class="n">sp500_returns_add</span> <span class="o">=</span> <span class="n">sp500_returns_add</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">remove_tickers_due_to_outliers</span><span class="p">,</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">study_returns</span> <span class="o">=</span> <span class="n">sp500_returns</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">sp500_returns_add</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">study_returns</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

<span class="n">estimation_data</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s2">&quot;2015-01-01&quot;</span><span class="p">):</span><span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="s2">&quot;2017-01-01&quot;</span><span class="p">)]</span>

<span class="n">na_per_ticker</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">available_tickers</span> <span class="o">=</span> <span class="n">na_per_ticker</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">na_per_ticker</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">estimation_data</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">available_tickers</span><span class="p">]</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">estimation_data</span><span class="p">)</span>
<span class="n">estimation_data_s</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">estimation_data</span><span class="p">)</span>

<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">svd_solver</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span>
<span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">estimation_data_s</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="p">),</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">(</span><span class="n">ax</span><span class="o">.</span><span class="n">get_yticks</span><span class="p">())</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="s2">&quot;1&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;Principal component&quot;</span><span class="p">)</span>
<span class="n">x_tick_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">40</span><span class="p">)]</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x_tick_idx</span><span class="p">)</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">estimation_data</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_tick_idx</span><span class="p">])</span>
<span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;PCA loading for company j&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/4ad1524e10bd746183080f1ec10bbd3f90ce4924a1338804c52cd800346950f3.png" src="_images/4ad1524e10bd746183080f1ec10bbd3f90ce4924a1338804c52cd800346950f3.png" />
</div>
</div>
<p>Regarding all remaining principal components, we examine that the overall group of companies is split into two subgroups which behave systematically different to each other. In the example of the last chapter, we observed that the sign split the companies by industry (technology and banking in our example). Even though, we do not know according to which attributes the companies are split into the subgroups, this represents an analogical proceeding as for Fama-French alike factor models. For instance, size is a variable which is used to build subgroups of companies and examine the difference in their value development. Regarding the size of a company, one usually observes higher returns for the portfolio including smaller companies (this is often referred to as the size effect). The difference in the portfolio returns of small and large sized companies stem from systematic differences in the value development of these companies. Thus, the company loadings of a company for the second (or third, or fourth, …) principal component may be good proxies for splitting the overall universe of assets in into subgroups which exhibit systematically different value behavior. If this is true, than the company specific loading vector <span class="math notranslate nohighlight">\(u_{j1}, ..., u_{jk}\)</span> maybe useful to characterize the systematic behavior of companies.</p>
<p>To examine this question, we are going to repeat the following proceeding over time:</p>
<ol class="arabic">
<li><p>Use daily data from the last <span class="math notranslate nohighlight">\(M\)</span> months to estimate <span class="math notranslate nohighlight">\(k\)</span> principal components (only for companies whose data is fully available during that time)</p></li>
<li><p>Form portfolios according to the principal component loadings:</p>
<p>2.1 For the first component, exclude all companies which do exhibit the same sign as the majority of companies; rank all loadings and build a portfolio with top 10% highest absolute loading values and the 10% with the lowest absolute values
2.2. For all remaining components, split the companies into two groups according to the sign of the component loading; build a portfolio with the 10% highest loading values of positive loadings and one with the 10% absolute highest loading values of negative loadings</p>
</li>
<li><p>For every portfolio, normalize the weights of each company such that they are proportional to the absolute loading</p></li>
<li><p>Hold these portfolio for <span class="math notranslate nohighlight">\(H\)</span> months.</p></li>
</ol>
<p>For a better understanding, let us go through these steps for a given estimation period with <span class="math notranslate nohighlight">\(M = 24\)</span> and <span class="math notranslate nohighlight">\(H=1\)</span>.</p>
<p>Step 1:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>


<span class="n">estimation_period_in_months</span> <span class="o">=</span> <span class="mi">24</span>

<span class="n">month_starts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;2015-01-01&quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;2024-06-01&quot;</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="s2">&quot;MS&quot;</span><span class="p">)</span>
<span class="n">month_ends</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;2015-01-01&quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;2024-07-01&quot;</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="s2">&quot;ME&quot;</span><span class="p">)</span>

<span class="n">t</span> <span class="o">=</span> <span class="n">estimation_period_in_months</span>
<span class="n">estimation_data</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="n">estimation_period_in_months</span><span class="p">]:</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span>
<span class="n">holding_data</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">]:</span><span class="n">month_ends</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span>

<span class="n">na_per_ticker</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">available_tickers</span> <span class="o">=</span> <span class="n">na_per_ticker</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">na_per_ticker</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">estimation_data</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">available_tickers</span><span class="p">]</span>
<span class="n">n_assets</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">estimation_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Estimation period, first observations for the first five companies:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">estimation_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">5</span><span class="p">])</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Holding1 period, first observations for the first five companies:&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="o">*</span><span class="mi">100</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="n">holding_data</span><span class="o">.</span><span class="n">head</span><span class="p">()</span><span class="o">.</span><span class="n">iloc</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">5</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>----------------------------------------------------------------------------------------------------
Estimation period, first observations for the first five companies:
----------------------------------------------------------------------------------------------------
ticker             A        AA       AAL       AAP      AAPL
date                                                        
2015-01-05 -0.018738 -0.057933 -0.000556 -0.013181 -0.028174
2015-01-06 -0.015578  0.007353 -0.015590 -0.000703  0.000097
2015-01-07  0.013272  0.025880 -0.000565  0.021488  0.014019
2015-01-08  0.029976  0.028459  0.012260  0.008766  0.038425
2015-01-09 -0.007336  0.013206 -0.030563 -0.005089  0.001069
----------------------------------------------------------------------------------------------------
Holding1 period, first observations for the first five companies:
----------------------------------------------------------------------------------------------------
ticker             A        AA       AAL       AAP      AAPL
date                                                        
2017-01-03  0.020413  0.026710 -0.008354  0.008751  0.002850
2017-01-04  0.013119  0.049602  0.008641  0.008206 -0.001120
2017-01-05 -0.011890  0.012887 -0.017346 -0.000698  0.005089
2017-01-06  0.031158  0.000979  0.006975 -0.013090  0.011146
2017-01-09  0.003124 -0.039113  0.018827 -0.000590  0.009159
</pre></div>
</div>
</div>
</div>
<p>Step 2.1:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">estimation_data</span><span class="p">)</span>
<span class="n">estimation_data_s</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">estimation_data</span><span class="p">)</span>

<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">svd_solver</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span>
<span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">estimation_data_s</span><span class="p">)</span>

<span class="n">pca_one_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="n">available_tickers</span><span class="p">,</span> <span class="s2">&quot;pca_1&quot;</span><span class="p">:</span> <span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]})</span>
<span class="n">pca_one_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;ticker&quot;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">average_sign_pca_one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">pca_one_df</span><span class="o">.</span><span class="n">pca_1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
<span class="k">if</span> <span class="n">average_sign_pca_one</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
    <span class="n">pca_one_ranks</span> <span class="o">=</span> <span class="n">pca_one_df</span><span class="p">[</span><span class="n">pca_one_df</span><span class="o">.</span><span class="n">pca_1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span><span class="p">)</span>    
<span class="k">else</span><span class="p">:</span>
    <span class="n">pca_one_ranks</span> <span class="o">=</span> <span class="n">pca_one_df</span><span class="p">[</span><span class="n">pca_one_df</span><span class="o">.</span><span class="n">pca_1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span><span class="p">)</span>

<span class="n">low_first_pca_loading_pf_tickers</span> <span class="o">=</span> <span class="n">pca_one_ranks</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">pca_one_ranks</span><span class="o">.</span><span class="n">pca_1</span> <span class="o">&lt;=</span> <span class="n">n_assets</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">high_first_pca_loading_pf_tickers</span> <span class="o">=</span> <span class="n">pca_one_ranks</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">pca_one_ranks</span><span class="o">.</span><span class="n">pca_1</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">pca_one_ranks</span><span class="o">.</span><span class="n">pca_1</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">n_assets</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">low_first_pca_weights</span> <span class="o">=</span> <span class="n">pca_one_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">low_first_pca_loading_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">/</span> <span class="n">pca_one_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">low_first_pca_loading_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">low_first_pca_weights</span> <span class="o">=</span> <span class="n">low_first_pca_weights</span><span class="o">.</span><span class="n">pca_1</span><span class="o">.</span><span class="n">values</span>
<span class="n">high_first_pca_weights</span> <span class="o">=</span> <span class="n">pca_one_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">high_first_pca_loading_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">/</span> <span class="n">pca_one_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">high_first_pca_loading_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">high_first_pca_weights</span> <span class="o">=</span> <span class="n">high_first_pca_weights</span><span class="o">.</span><span class="n">pca_1</span><span class="o">.</span><span class="n">values</span>

<span class="n">low_first_pca_holding_returns_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">holding_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">low_first_pca_loading_pf_tickers</span><span class="p">]</span> <span class="o">*</span> <span class="n">low_first_pca_weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">high_first_pca_holding_returns_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">holding_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">high_first_pca_loading_pf_tickers</span><span class="p">]</span> <span class="o">*</span> <span class="n">high_first_pca_weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Companies in the portfolio with lowest absolute values of the first component: </span><span class="si">{</span><span class="n">low_first_pca_loading_pf_tickers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Corresponding loadings of the first principal component: </span><span class="si">{</span><span class="n">pca_one_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">low_first_pca_loading_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">pca_1</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Corresponding portfolio weights: </span><span class="si">{</span><span class="n">low_first_pca_weights</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Companies in the portfolio with highest absolute values of the first component: </span><span class="si">{</span><span class="n">high_first_pca_loading_pf_tickers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Corresponding loadings of the first principal component: </span><span class="si">{</span><span class="n">pca_one_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">high_first_pca_loading_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">pca_1</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Corresponding portfolio weights: </span><span class="si">{</span><span class="n">high_first_pca_weights</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Companies in the portfolio with lowest absolute values of the first component: [&#39;ABMD&#39;, &#39;APOL&#39;, &#39;CBOE&#39;, &#39;CLF&#39;, &#39;CMG&#39;, &#39;CTX&#39;, &#39;CZR&#39;, &#39;DHR&#39;, &#39;DXC&#39;, &#39;ED&#39;, &#39;EIX&#39;, &#39;ENDP&#39;, &#39;ENPH&#39;, &#39;EVHC&#39;, &#39;KHC&#39;, &#39;KSS&#39;, &#39;LULU&#39;, &#39;NEM&#39;, &#39;O&#39;, &#39;ODP&#39;, &#39;RAD&#39;, &#39;RAI&#39;, &#39;SII&#39;, &#39;SO&#39;, &#39;TSG&#39;, &#39;TSN&#39;, &#39;TWTR&#39;, &#39;URBN&#39;, &#39;WFM&#39;, &#39;ABR-PB&#39;, &#39;AGO-P-E&#39;, &#39;AMH-PC&#39;, &#39;BAC-P-E&#39;, &#39;BML-PL&#39;, &#39;BOIL&#39;, &#39;C-P-L&#39;, &#39;CVUA&#39;, &#39;CWEI&#39;, &#39;ENZ&#39;, &#39;EUO&#39;, &#39;FSCE&#39;, &#39;FSLF&#39;, &#39;GAM-P-B&#39;, &#39;GDXJ&#39;, &#39;GFY&#39;, &#39;GS-PC&#39;, &#39;GS-PI&#39;, &#39;GST&#39;, &#39;JPM-P-E&#39;, &#39;JPM-PE&#39;, &#39;LEO&#39;, &#39;MEN&#39;, &#39;MH-P-A&#39;, &#39;NM&#39;, &#39;NMZ&#39;, &#39;NXC&#39;, &#39;OFC-P-L&#39;, &#39;P&#39;, &#39;PAI&#39;, &#39;PCG-P-C&#39;, &#39;PGD&#39;, &#39;PMO&#39;, &#39;PNC-P-Q&#39;, &#39;RF-P-A&#39;, &#39;SBI&#39;, &#39;SCE-P-H&#39;, &#39;SCPX&#39;, &#39;SGY&#39;, &#39;SIRE&#39;, &#39;STAR-P-E&#39;, &#39;TCO-P-J&#39;, &#39;TNP-PB&#39;, &#39;TRNO-PA&#39;, &#39;VBF&#39;, &#39;VEC&#39;, &#39;VNO-P-I&#39;, &#39;WFC-P-R&#39;, &#39;XPL&#39;]
Corresponding loadings of the first principal component: [-0.0191, -0.0146, -0.0193, -0.0177, -0.0167, -0.0191, -0.0158, -0.014, -0.016, -0.0154, -0.0206, -0.0206, -0.0196, -0.0211, -0.0193, -0.02, -0.0211, -0.0086, -0.0203, -0.0212, -0.0122, -0.0209, -0.0169, -0.0201, -0.0179, -0.0194, -0.0188, -0.021, -0.0209, -0.0133, -0.0116, -0.0098, -0.0152, -0.0131, -0.0031, -0.0159, -0.0061, -0.0195, -0.0118, -0.006, -0.0093, -0.0191, -0.0006, -0.0062, -0.0193, -0.014, -0.0122, -0.0199, -0.0106, -0.0114, -0.0021, -0.0002, -0.0035, -0.0206, -0.004, -0.0045, -0.0052, -0.0154, -0.0083, -0.0037, -0.0002, -0.0032, -0.0202, -0.0212, -0.0079, -0.0138, -0.0087, -0.0206, -0.0159, -0.0166, -0.0097, -0.0138, -0.004, -0.0059, -0.0171, -0.0171, -0.0188, -0.0017]
Corresponding portfolio weights: [0.018, 0.0138, 0.0182, 0.0167, 0.0157, 0.018, 0.0149, 0.0132, 0.0151, 0.0145, 0.0194, 0.0194, 0.0185, 0.0199, 0.0182, 0.0189, 0.0199, 0.0081, 0.0192, 0.02, 0.0115, 0.0197, 0.0159, 0.0189, 0.0169, 0.0183, 0.0178, 0.0198, 0.0197, 0.0125, 0.011, 0.0092, 0.0144, 0.0123, 0.0029, 0.015, 0.0057, 0.0184, 0.0111, 0.0057, 0.0087, 0.018, 0.0005, 0.0059, 0.0182, 0.0132, 0.0115, 0.0187, 0.01, 0.0107, 0.002, 0.0002, 0.0033, 0.0194, 0.0038, 0.0043, 0.0049, 0.0145, 0.0078, 0.0035, 0.0002, 0.003, 0.0191, 0.02, 0.0075, 0.013, 0.0082, 0.0194, 0.015, 0.0156, 0.0092, 0.013, 0.0037, 0.0055, 0.0162, 0.0161, 0.0178, 0.0016]
Companies in the portfolio with highest absolute values of the first component: [&#39;A&#39;, &#39;ADP&#39;, &#39;AFL&#39;, &#39;AIG&#39;, &#39;AJG&#39;, &#39;AME&#39;, &#39;AMG&#39;, &#39;AMP&#39;, &#39;AON&#39;, &#39;APH&#39;, &#39;BAC&#39;, &#39;BEN&#39;, &#39;BK&#39;, &#39;BLK&#39;, &#39;C&#39;, &#39;CB&#39;, &#39;CBRE&#39;, &#39;CINF&#39;, &#39;ECL&#39;, &#39;ETN&#39;, &#39;FHN&#39;, &#39;FI&#39;, &#39;FII&#39;, &#39;FITB&#39;, &#39;GL&#39;, &#39;GPC&#39;, &#39;GS&#39;, &#39;HON&#39;, &#39;HUBB&#39;, &#39;IEX&#39;, &#39;ITW&#39;, &#39;IVZ&#39;, &#39;JPM&#39;, &#39;L&#39;, &#39;LM&#39;, &#39;LNC&#39;, &#39;MA&#39;, &#39;MCO&#39;, &#39;MMC&#39;, &#39;MS&#39;, &#39;NTRS&#39;, &#39;OMC&#39;, &#39;ORCL&#39;, &#39;PAYX&#39;, &#39;PCAR&#39;, &#39;PFG&#39;, &#39;PH&#39;, &#39;PNC&#39;, &#39;PPG&#39;, &#39;PRU&#39;, &#39;ROP&#39;, &#39;SCHW&#39;, &#39;SNA&#39;, &#39;SPGI&#39;, &#39;STT&#39;, &#39;SWK&#39;, &#39;TDY&#39;, &#39;TEL&#39;, &#39;TFC&#39;, &#39;TMO&#39;, &#39;TROW&#39;, &#39;TT&#39;, &#39;UNM&#39;, &#39;USB&#39;, &#39;WFC&#39;, &#39;XYL&#39;, &#39;AIVI&#39;, &#39;BVAL&#39;, &#39;CZA&#39;, &#39;EMF&#39;, &#39;IJJ&#39;, &#39;IYY&#39;, &#39;LIT&#39;, &#39;MIDU&#39;, &#39;NFRA&#39;, &#39;SPYG&#39;, &#39;VIG&#39;, &#39;VXF&#39;]
Corresponding loadings of the first principal component: [-0.0503, -0.0496, -0.0494, -0.0484, -0.0483, -0.0486, -0.0505, -0.0498, -0.0476, -0.049, -0.0472, -0.0503, -0.0496, -0.0539, -0.0514, -0.0478, -0.0485, -0.0489, -0.0473, -0.0479, -0.0472, -0.0492, -0.048, -0.0468, -0.0501, -0.0472, -0.0504, -0.0497, -0.047, -0.0504, -0.0515, -0.0533, -0.0516, -0.0494, -0.0483, -0.048, -0.0488, -0.0502, -0.053, -0.0508, -0.0495, -0.0486, -0.0468, -0.048, -0.0477, -0.0527, -0.0468, -0.0497, -0.0506, -0.0489, -0.0473, -0.0472, -0.0468, -0.0477, -0.0483, -0.0479, -0.0488, -0.05, -0.0493, -0.0484, -0.0512, -0.048, -0.0468, -0.0515, -0.0486, -0.0485, -0.0527, -0.0604, -0.0611, -0.0468, -0.0617, -0.0632, -0.0479, -0.0627, -0.056, -0.0603, -0.0611, -0.0621]
Corresponding portfolio weights: [0.0128, 0.0126, 0.0125, 0.0123, 0.0123, 0.0123, 0.0128, 0.0127, 0.0121, 0.0124, 0.012, 0.0128, 0.0126, 0.0137, 0.0131, 0.0121, 0.0123, 0.0124, 0.012, 0.0122, 0.012, 0.0125, 0.0122, 0.0119, 0.0127, 0.012, 0.0128, 0.0126, 0.0119, 0.0128, 0.0131, 0.0135, 0.0131, 0.0125, 0.0123, 0.0122, 0.0124, 0.0128, 0.0135, 0.0129, 0.0126, 0.0123, 0.0119, 0.0122, 0.0121, 0.0134, 0.0119, 0.0126, 0.0128, 0.0124, 0.012, 0.012, 0.0119, 0.0121, 0.0123, 0.0122, 0.0124, 0.0127, 0.0125, 0.0123, 0.013, 0.0122, 0.0119, 0.0131, 0.0123, 0.0123, 0.0134, 0.0154, 0.0155, 0.0119, 0.0157, 0.016, 0.0122, 0.0159, 0.0142, 0.0153, 0.0155, 0.0158]
</pre></div>
</div>
</div>
</div>
<p>Step 2.2:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># pca 2</span>
<span class="n">pca_two_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="n">available_tickers</span><span class="p">,</span> <span class="s2">&quot;pca_2&quot;</span><span class="p">:</span> <span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]})</span>
<span class="n">pca_two_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;ticker&quot;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">pca_two_positive_loadings</span> <span class="o">=</span> <span class="n">pca_two_df</span><span class="p">[</span><span class="n">pca_two_df</span><span class="o">.</span><span class="n">pca_2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">pca_two_positive_loadings_pf_tickers</span> <span class="o">=</span> <span class="n">pca_two_positive_loadings</span><span class="o">.</span><span class="n">index</span><span class="p">[(</span><span class="n">pca_two_positive_loadings</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">n_assets</span><span class="p">)</span><span class="o">.</span><span class="n">pca_2</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">pca_two_positive_loadings_pf_weights</span> <span class="o">=</span> <span class="n">pca_two_positive_loadings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pca_two_positive_loadings_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">/</span> <span class="n">pca_two_positive_loadings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pca_two_positive_loadings_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">pca_two_positive_loadings_pf_weights</span> <span class="o">=</span> <span class="n">pca_two_positive_loadings_pf_weights</span><span class="o">.</span><span class="n">pca_2</span><span class="o">.</span><span class="n">values</span>

<span class="n">pca_two_negative_loadings</span> <span class="o">=</span> <span class="n">pca_two_df</span><span class="p">[</span><span class="n">pca_two_df</span><span class="o">.</span><span class="n">pca_2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
<span class="n">pca_two_negative_loadings_pf_tickers</span> <span class="o">=</span> <span class="n">pca_two_negative_loadings</span><span class="o">.</span><span class="n">index</span><span class="p">[(</span><span class="n">pca_two_negative_loadings</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">n_assets</span><span class="p">)</span><span class="o">.</span><span class="n">pca_2</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">pca_two_negative_loadings_pf_weights</span> <span class="o">=</span> <span class="n">pca_two_negative_loadings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pca_two_negative_loadings_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">/</span> <span class="n">pca_two_negative_loadings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pca_two_negative_loadings_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">pca_two_negative_loadings_pf_weights</span> <span class="o">=</span> <span class="n">pca_two_negative_loadings_pf_weights</span><span class="o">.</span><span class="n">pca_2</span><span class="o">.</span><span class="n">values</span>

<span class="n">pca_two_positive_pf_returns_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">holding_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">pca_two_positive_loadings_pf_tickers</span><span class="p">]</span> <span class="o">*</span> <span class="n">pca_two_positive_loadings_pf_weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">pca_two_negative_pf_returns_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">holding_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">pca_two_negative_loadings_pf_tickers</span><span class="p">]</span> <span class="o">*</span> <span class="n">pca_two_negative_loadings_pf_weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Companies in the portfolio for the second component with positive loadings: </span><span class="si">{</span><span class="n">pca_two_positive_loadings_pf_tickers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Corresponding loadings of the second principal component: </span><span class="si">{</span><span class="n">pca_two_positive_loadings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pca_two_positive_loadings_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">pca_2</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Corresponding portfolio weights: </span><span class="si">{</span><span class="n">pca_two_positive_loadings_pf_weights</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Companies in the portfolio for the second component with negative loadings: </span><span class="si">{</span><span class="n">pca_two_negative_loadings_pf_tickers</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Corresponding loadings of the second principal component: </span><span class="si">{</span><span class="n">pca_two_negative_loadings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pca_two_negative_loadings_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">pca_2</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Corresponding portfolio weights: </span><span class="si">{</span><span class="n">pca_two_negative_loadings_pf_weights</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Companies in the portfolio for the second component with positive loadings: [&#39;AKS&#39;, &#39;AMG&#39;, &#39;AMP&#39;, &#39;APA&#39;, &#39;APC&#39;, &#39;ATI&#39;, &#39;BAC&#39;, &#39;BK&#39;, &#39;BKR&#39;, &#39;C&#39;, &#39;CAT&#39;, &#39;CF&#39;, &#39;CFG&#39;, &#39;CMA&#39;, &#39;CNX&#39;, &#39;COF&#39;, &#39;COP&#39;, &#39;CXO&#39;, &#39;DNR&#39;, &#39;DOV&#39;, &#39;DVN&#39;, &#39;EOG&#39;, &#39;ESV&#39;, &#39;ETFC&#39;, &#39;FANG&#39;, &#39;FCX&#39;, &#39;FHN&#39;, &#39;FITB&#39;, &#39;FLR&#39;, &#39;FLS&#39;, &#39;GNW&#39;, &#39;GS&#39;, &#39;HAL&#39;, &#39;HBAN&#39;, &#39;HES&#39;, &#39;HP&#39;, &#39;ITT&#39;, &#39;JOY&#39;, &#39;KEY&#39;, &#39;LNC&#39;, &#39;LYB&#39;, &#39;MET&#39;, &#39;MOS&#39;, &#39;MRO&#39;, &#39;MS&#39;, &#39;MUR&#39;, &#39;NAVI&#39;, &#39;NBL&#39;, &#39;NBR&#39;, &#39;NOV&#39;, &#39;PNC&#39;, &#39;PRU&#39;, &#39;QEP&#39;, &#39;RDC&#39;, &#39;RF&#39;, &#39;RIG&#39;, &#39;RJF&#39;, &#39;RRC&#39;, &#39;SCHW&#39;, &#39;SIVB&#39;, &#39;SLB&#39;, &#39;SLM&#39;, &#39;SWN&#39;, &#39;TFC&#39;, &#39;TRGP&#39;, &#39;UNM&#39;, &#39;URI&#39;, &#39;USL&#39;, &#39;WPX&#39;, &#39;XEC&#39;, &#39;ZION&#39;, &#39;CWEI&#39;, &#39;GST&#39;, &#39;HLX&#39;, &#39;OIH&#39;, &#39;SM&#39;, &#39;VDE&#39;, &#39;WBS&#39;]
Corresponding loadings of the second principal component: [0.045, 0.0427, 0.0457, 0.0535, 0.0499, 0.0459, 0.0598, 0.0418, 0.0449, 0.0474, 0.0471, 0.0451, 0.0595, 0.0594, 0.0454, 0.0456, 0.0523, 0.0442, 0.0619, 0.0417, 0.0533, 0.0424, 0.0665, 0.0497, 0.0417, 0.0479, 0.0526, 0.055, 0.042, 0.0582, 0.0504, 0.0439, 0.05, 0.0515, 0.0529, 0.0606, 0.0531, 0.0479, 0.0507, 0.0565, 0.0457, 0.056, 0.0442, 0.0563, 0.047, 0.0599, 0.0447, 0.0439, 0.0588, 0.0538, 0.0465, 0.049, 0.0497, 0.0651, 0.0616, 0.0631, 0.0488, 0.0417, 0.0527, 0.0592, 0.0421, 0.0481, 0.047, 0.0481, 0.0418, 0.0566, 0.05, 0.0556, 0.056, 0.0459, 0.0654, 0.0494, 0.046, 0.0543, 0.0652, 0.0595, 0.0476, 0.0493]
Corresponding portfolio weights: [0.0113, 0.0107, 0.0115, 0.0134, 0.0125, 0.0115, 0.015, 0.0105, 0.0113, 0.0119, 0.0118, 0.0113, 0.0149, 0.0149, 0.0114, 0.0115, 0.0131, 0.0111, 0.0155, 0.0105, 0.0134, 0.0107, 0.0167, 0.0125, 0.0105, 0.012, 0.0132, 0.0138, 0.0106, 0.0146, 0.0127, 0.011, 0.0126, 0.0129, 0.0133, 0.0152, 0.0133, 0.012, 0.0127, 0.0142, 0.0115, 0.0141, 0.0111, 0.0141, 0.0118, 0.015, 0.0112, 0.011, 0.0148, 0.0135, 0.0117, 0.0123, 0.0125, 0.0164, 0.0155, 0.0159, 0.0123, 0.0105, 0.0132, 0.0149, 0.0106, 0.0121, 0.0118, 0.0121, 0.0105, 0.0142, 0.0126, 0.014, 0.0141, 0.0115, 0.0164, 0.0124, 0.0115, 0.0136, 0.0164, 0.015, 0.0119, 0.0124]
Companies in the portfolio for the second component with negative loadings: [&#39;AEE&#39;, &#39;AEP&#39;, &#39;AIV&#39;, &#39;AMT&#39;, &#39;ARE&#39;, &#39;ATO&#39;, &#39;AVB&#39;, &#39;AWK&#39;, &#39;BXP&#39;, &#39;CCI&#39;, &#39;CHD&#39;, &#39;CLX&#39;, &#39;CMS&#39;, &#39;CPB&#39;, &#39;CPT&#39;, &#39;D&#39;, &#39;DLR&#39;, &#39;DOC&#39;, &#39;DPS&#39;, &#39;DRE&#39;, &#39;DTE&#39;, &#39;DUK&#39;, &#39;ED&#39;, &#39;EIX&#39;, &#39;EQR&#39;, &#39;ES&#39;, &#39;ESS&#39;, &#39;ETR&#39;, &#39;EVRG&#39;, &#39;EXC&#39;, &#39;EXR&#39;, &#39;FE&#39;, &#39;FRT&#39;, &#39;GGP&#39;, &#39;GIS&#39;, &#39;HRL&#39;, &#39;K&#39;, &#39;KDP&#39;, &#39;KIM&#39;, &#39;KMB&#39;, &#39;KO&#39;, &#39;LNT&#39;, &#39;LSI&#39;, &#39;MAA&#39;, &#39;MKC&#39;, &#39;MO&#39;, &#39;NEE&#39;, &#39;NI&#39;, &#39;O&#39;, &#39;PCG&#39;, &#39;PEG&#39;, &#39;PEP&#39;, &#39;PLD&#39;, &#39;PM&#39;, &#39;PNW&#39;, &#39;PPL&#39;, &#39;PSA&#39;, &#39;RAI&#39;, &#39;REG&#39;, &#39;SCG&#39;, &#39;SO&#39;, &#39;SPG&#39;, &#39;SRE&#39;, &#39;UDR&#39;, &#39;VNO&#39;, &#39;VTR&#39;, &#39;WEC&#39;, &#39;WELL&#39;, &#39;XEL&#39;, &#39;ACC&#39;, &#39;AKR&#39;, &#39;BSV&#39;, &#39;EPR&#39;, &#39;OHI&#39;, &#39;REZ&#39;, &#39;SCHR&#39;, &#39;VER&#39;, &#39;WRI&#39;]
Corresponding loadings of the second principal component: [-0.102, -0.1031, -0.0792, -0.0542, -0.0693, -0.0943, -0.0801, -0.0996, -0.0607, -0.0606, -0.0576, -0.0801, -0.1089, -0.0643, -0.078, -0.0925, -0.0787, -0.0615, -0.0767, -0.0766, -0.1038, -0.1016, -0.1113, -0.1001, -0.0756, -0.1084, -0.0729, -0.0898, -0.0714, -0.0559, -0.0817, -0.0673, -0.0941, -0.0673, -0.0675, -0.0654, -0.064, -0.071, -0.085, -0.0564, -0.0592, -0.1062, -0.0784, -0.0855, -0.0631, -0.0819, -0.101, -0.0845, -0.1034, -0.0983, -0.0834, -0.0647, -0.0696, -0.0607, -0.1089, -0.0824, -0.0801, -0.0619, -0.0896, -0.1053, -0.1039, -0.082, -0.0785, -0.0756, -0.0548, -0.0869, -0.1113, -0.0841, -0.11, -0.0858, -0.0833, -0.0644, -0.0875, -0.0771, -0.0954, -0.0733, -0.0648, -0.0851]
Corresponding portfolio weights: [0.016, 0.0162, 0.0125, 0.0085, 0.0109, 0.0148, 0.0126, 0.0157, 0.0095, 0.0095, 0.0091, 0.0126, 0.0171, 0.0101, 0.0123, 0.0145, 0.0124, 0.0097, 0.0121, 0.012, 0.0163, 0.016, 0.0175, 0.0157, 0.0119, 0.017, 0.0115, 0.0141, 0.0112, 0.0088, 0.0128, 0.0106, 0.0148, 0.0106, 0.0106, 0.0103, 0.0101, 0.0112, 0.0134, 0.0089, 0.0093, 0.0167, 0.0123, 0.0134, 0.0099, 0.0129, 0.0159, 0.0133, 0.0163, 0.0155, 0.0131, 0.0102, 0.0109, 0.0095, 0.0171, 0.013, 0.0126, 0.0097, 0.0141, 0.0166, 0.0163, 0.0129, 0.0123, 0.0119, 0.0086, 0.0137, 0.0175, 0.0132, 0.0173, 0.0135, 0.0131, 0.0101, 0.0138, 0.0121, 0.015, 0.0115, 0.0102, 0.0134]
</pre></div>
</div>
</div>
</div>
<p>This is repeated for as many principal components as desired. Portfolio returns are determined by multiplying the weights from above the daily returns for the next month.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">holding_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">low_first_pca_holding_returns_tmp</span><span class="p">,</span> <span class="n">high_first_pca_holding_returns_tmp</span><span class="p">,</span> <span class="n">pca_two_negative_pf_returns_tmp</span><span class="p">,</span> <span class="n">pca_two_positive_pf_returns_tmp</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span>  <span class="mi">1</span><span class="p">)</span>
<span class="n">holding_returns</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Low_Fst_PCA&quot;</span><span class="p">,</span> <span class="s2">&quot;High_Fst_PCA&quot;</span><span class="p">,</span> <span class="s2">&quot;Negative_Snd_PCA&quot;</span><span class="p">,</span> <span class="s2">&quot;Positive_Snd_PCA&quot;</span><span class="p">]</span>
<span class="n">holding_returns</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>Low_Fst_PCA</th>
      <th>High_Fst_PCA</th>
      <th>Negative_Snd_PCA</th>
      <th>Positive_Snd_PCA</th>
    </tr>
    <tr>
      <th>date</th>
      <th></th>
      <th></th>
      <th></th>
      <th></th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>2017-01-03</th>
      <td>0.007540</td>
      <td>0.009037</td>
      <td>-0.000464</td>
      <td>0.013535</td>
    </tr>
    <tr>
      <th>2017-01-04</th>
      <td>0.013954</td>
      <td>0.011350</td>
      <td>0.007952</td>
      <td>0.016343</td>
    </tr>
    <tr>
      <th>2017-01-05</th>
      <td>-0.004757</td>
      <td>-0.006251</td>
      <td>0.003637</td>
      <td>-0.005183</td>
    </tr>
    <tr>
      <th>2017-01-06</th>
      <td>-0.003724</td>
      <td>0.004244</td>
      <td>-0.000126</td>
      <td>0.003807</td>
    </tr>
    <tr>
      <th>2017-01-09</th>
      <td>-0.004938</td>
      <td>-0.008358</td>
      <td>-0.011069</td>
      <td>-0.015917</td>
    </tr>
    <tr>
      <th>2017-01-10</th>
      <td>0.002591</td>
      <td>0.002859</td>
      <td>-0.006720</td>
      <td>0.002897</td>
    </tr>
    <tr>
      <th>2017-01-11</th>
      <td>0.006025</td>
      <td>0.006448</td>
      <td>0.000805</td>
      <td>0.011445</td>
    </tr>
    <tr>
      <th>2017-01-12</th>
      <td>-0.003364</td>
      <td>-0.004242</td>
      <td>0.003356</td>
      <td>-0.009581</td>
    </tr>
    <tr>
      <th>2017-01-13</th>
      <td>0.003310</td>
      <td>0.004410</td>
      <td>-0.002212</td>
      <td>-0.000363</td>
    </tr>
    <tr>
      <th>2017-01-17</th>
      <td>0.008613</td>
      <td>-0.012601</td>
      <td>0.010727</td>
      <td>-0.009125</td>
    </tr>
    <tr>
      <th>2017-01-18</th>
      <td>0.003641</td>
      <td>0.004815</td>
      <td>0.000032</td>
      <td>0.005406</td>
    </tr>
    <tr>
      <th>2017-01-19</th>
      <td>-0.007292</td>
      <td>-0.004559</td>
      <td>-0.008502</td>
      <td>-0.004700</td>
    </tr>
    <tr>
      <th>2017-01-20</th>
      <td>0.005749</td>
      <td>0.004787</td>
      <td>0.005001</td>
      <td>0.006932</td>
    </tr>
    <tr>
      <th>2017-01-23</th>
      <td>-0.001451</td>
      <td>-0.003289</td>
      <td>0.002225</td>
      <td>-0.009331</td>
    </tr>
    <tr>
      <th>2017-01-24</th>
      <td>0.007856</td>
      <td>0.011864</td>
      <td>0.000665</td>
      <td>0.020162</td>
    </tr>
    <tr>
      <th>2017-01-25</th>
      <td>0.001321</td>
      <td>0.011002</td>
      <td>-0.004184</td>
      <td>0.012872</td>
    </tr>
    <tr>
      <th>2017-01-26</th>
      <td>-0.004956</td>
      <td>-0.003252</td>
      <td>-0.001053</td>
      <td>0.000567</td>
    </tr>
    <tr>
      <th>2017-01-27</th>
      <td>-0.004764</td>
      <td>-0.003449</td>
      <td>-0.004930</td>
      <td>-0.008669</td>
    </tr>
    <tr>
      <th>2017-01-30</th>
      <td>-0.007799</td>
      <td>-0.005533</td>
      <td>-0.001823</td>
      <td>-0.021872</td>
    </tr>
    <tr>
      <th>2017-01-31</th>
      <td>0.007259</td>
      <td>-0.002342</td>
      <td>0.009911</td>
      <td>-0.001444</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p><strong>Results for a rolling window approach</strong></p>
<p>The procedure from above is now repeated over the time period between 2015 and 2024 using three principal components. With an estimation period of 24 months, the first portfolio returns start in the beginning of 2017. Below we see the aggregated performance measured by the mean returns, the standard deviation, and the ratio of the mean and standard deviation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="n">estimation_period_in_months</span> <span class="o">=</span> <span class="mi">24</span>

<span class="n">month_starts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;2015-01-01&quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;2024-06-01&quot;</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="s2">&quot;MS&quot;</span><span class="p">)</span>
<span class="n">month_ends</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;2015-01-01&quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;2024-07-01&quot;</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="s2">&quot;ME&quot;</span><span class="p">)</span>

<span class="n">tickers_in_portfolio_pca_low</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">month_starts</span><span class="p">[</span><span class="n">estimation_period_in_months</span><span class="p">:],</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="n">tickers_in_portfolio_pca_high</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">month_starts</span><span class="p">[</span><span class="n">estimation_period_in_months</span><span class="p">:],</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

<span class="n">tickers_in_portfolio_pca_two_positive</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">month_starts</span><span class="p">[</span><span class="n">estimation_period_in_months</span><span class="p">:],</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="n">tickers_in_portfolio_pca_two_negative</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">month_starts</span><span class="p">[</span><span class="n">estimation_period_in_months</span><span class="p">:],</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

<span class="n">tickers_in_portfolio_pca_three_positive</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">month_starts</span><span class="p">[</span><span class="n">estimation_period_in_months</span><span class="p">:],</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
<span class="n">tickers_in_portfolio_pca_three_negative</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">data</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">month_starts</span><span class="p">[</span><span class="n">estimation_period_in_months</span><span class="p">:],</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">estimation_period_in_months</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">month_starts</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">estimation_data</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="n">estimation_period_in_months</span><span class="p">]:</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span>
    <span class="n">holding_data</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">]:</span><span class="n">month_ends</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span>

    <span class="n">na_per_ticker</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">available_tickers</span> <span class="o">=</span> <span class="n">na_per_ticker</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">na_per_ticker</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">estimation_data</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">available_tickers</span><span class="p">]</span>
    <span class="n">n_assets</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">estimation_data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.1</span><span class="p">)</span>

    <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">estimation_data</span><span class="p">)</span>
    <span class="n">estimation_data_s</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">estimation_data</span><span class="p">)</span>

    <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">svd_solver</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span>
    <span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">estimation_data_s</span><span class="p">)</span>

    <span class="n">pca_one_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="n">available_tickers</span><span class="p">,</span> <span class="s2">&quot;pca_1&quot;</span><span class="p">:</span> <span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]})</span>
    <span class="n">pca_one_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;ticker&quot;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">average_sign_pca_one</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">pca_one_df</span><span class="o">.</span><span class="n">pca_1</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">average_sign_pca_one</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">pca_one_ranks</span> <span class="o">=</span> <span class="n">pca_one_df</span><span class="p">[</span><span class="n">pca_one_df</span><span class="o">.</span><span class="n">pca_1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span><span class="p">)</span>    
    <span class="k">else</span><span class="p">:</span>
        <span class="n">pca_one_ranks</span> <span class="o">=</span> <span class="n">pca_one_df</span><span class="p">[</span><span class="n">pca_one_df</span><span class="o">.</span><span class="n">pca_1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span><span class="p">)</span>

    <span class="n">low_first_pca_loading_pf_tickers</span> <span class="o">=</span> <span class="n">pca_one_ranks</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">pca_one_ranks</span><span class="o">.</span><span class="n">pca_1</span> <span class="o">&lt;=</span> <span class="n">n_assets</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">tickers_in_portfolio_pca_low</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">low_first_pca_loading_pf_tickers</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">high_first_pca_loading_pf_tickers</span> <span class="o">=</span> <span class="n">pca_one_ranks</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">pca_one_ranks</span><span class="o">.</span><span class="n">pca_1</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="n">pca_one_ranks</span><span class="o">.</span><span class="n">pca_1</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">-</span> <span class="n">n_assets</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">tickers_in_portfolio_pca_high</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">high_first_pca_loading_pf_tickers</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">low_first_pca_weights</span> <span class="o">=</span> <span class="n">pca_one_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">low_first_pca_loading_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">/</span> <span class="n">pca_one_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">low_first_pca_loading_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">low_first_pca_weights</span> <span class="o">=</span> <span class="n">low_first_pca_weights</span><span class="o">.</span><span class="n">pca_1</span><span class="o">.</span><span class="n">values</span>
    <span class="n">high_first_pca_weights</span> <span class="o">=</span> <span class="n">pca_one_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">high_first_pca_loading_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">/</span> <span class="n">pca_one_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">high_first_pca_loading_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">high_first_pca_weights</span> <span class="o">=</span> <span class="n">high_first_pca_weights</span><span class="o">.</span><span class="n">pca_1</span><span class="o">.</span><span class="n">values</span>

    <span class="n">low_first_pca_holding_returns_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">holding_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">low_first_pca_loading_pf_tickers</span><span class="p">]</span> <span class="o">*</span> <span class="n">low_first_pca_weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">high_first_pca_holding_returns_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">holding_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">high_first_pca_loading_pf_tickers</span><span class="p">]</span> <span class="o">*</span> <span class="n">high_first_pca_weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># pca 2</span>
    <span class="n">pca_two_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="n">available_tickers</span><span class="p">,</span> <span class="s2">&quot;pca_2&quot;</span><span class="p">:</span> <span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]})</span>
    <span class="n">pca_two_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;ticker&quot;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">pca_two_positive_loadings</span> <span class="o">=</span> <span class="n">pca_two_df</span><span class="p">[</span><span class="n">pca_two_df</span><span class="o">.</span><span class="n">pca_2</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">pca_two_positive_loadings_pf_tickers</span> <span class="o">=</span> <span class="n">pca_two_positive_loadings</span><span class="o">.</span><span class="n">index</span><span class="p">[(</span><span class="n">pca_two_positive_loadings</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">n_assets</span><span class="p">)</span><span class="o">.</span><span class="n">pca_2</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">tickers_in_portfolio_pca_two_positive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">pca_two_positive_loadings_pf_tickers</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">pca_two_positive_loadings_pf_weights</span> <span class="o">=</span> <span class="n">pca_two_positive_loadings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pca_two_positive_loadings_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">/</span> <span class="n">pca_two_positive_loadings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pca_two_positive_loadings_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">pca_two_positive_loadings_pf_weights</span> <span class="o">=</span> <span class="n">pca_two_positive_loadings_pf_weights</span><span class="o">.</span><span class="n">pca_2</span><span class="o">.</span><span class="n">values</span>

    <span class="n">pca_two_negative_loadings</span> <span class="o">=</span> <span class="n">pca_two_df</span><span class="p">[</span><span class="n">pca_two_df</span><span class="o">.</span><span class="n">pca_2</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">pca_two_negative_loadings_pf_tickers</span> <span class="o">=</span> <span class="n">pca_two_negative_loadings</span><span class="o">.</span><span class="n">index</span><span class="p">[(</span><span class="n">pca_two_negative_loadings</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">n_assets</span><span class="p">)</span><span class="o">.</span><span class="n">pca_2</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">tickers_in_portfolio_pca_two_negative</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">pca_two_negative_loadings_pf_tickers</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">pca_two_negative_loadings_pf_weights</span> <span class="o">=</span> <span class="n">pca_two_negative_loadings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pca_two_negative_loadings_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">/</span> <span class="n">pca_two_negative_loadings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pca_two_negative_loadings_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">pca_two_negative_loadings_pf_weights</span> <span class="o">=</span> <span class="n">pca_two_negative_loadings_pf_weights</span><span class="o">.</span><span class="n">pca_2</span><span class="o">.</span><span class="n">values</span>
    
    <span class="n">pca_two_positive_pf_returns_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">holding_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">pca_two_positive_loadings_pf_tickers</span><span class="p">]</span> <span class="o">*</span> <span class="n">pca_two_positive_loadings_pf_weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">pca_two_negative_pf_returns_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">holding_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">pca_two_negative_loadings_pf_tickers</span><span class="p">]</span> <span class="o">*</span> <span class="n">pca_two_negative_loadings_pf_weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

    <span class="c1"># pca 3</span>
    <span class="n">pca_three_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s2">&quot;ticker&quot;</span><span class="p">:</span> <span class="n">available_tickers</span><span class="p">,</span> <span class="s2">&quot;pca_3&quot;</span><span class="p">:</span> <span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="p">:]})</span>
    <span class="n">pca_three_df</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s2">&quot;ticker&quot;</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">pca_three_positive_loadings</span> <span class="o">=</span> <span class="n">pca_three_df</span><span class="p">[</span><span class="n">pca_three_df</span><span class="o">.</span><span class="n">pca_3</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">pca_three_positive_loadings_pf_tickers</span> <span class="o">=</span> <span class="n">pca_three_positive_loadings</span><span class="o">.</span><span class="n">index</span><span class="p">[(</span><span class="n">pca_three_positive_loadings</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">n_assets</span><span class="p">)</span><span class="o">.</span><span class="n">pca_3</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">tickers_in_portfolio_pca_three_positive</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">pca_three_positive_loadings_pf_tickers</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">pca_three_positive_loadings_pf_weights</span> <span class="o">=</span> <span class="n">pca_three_positive_loadings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pca_three_positive_loadings_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">/</span> <span class="n">pca_three_positive_loadings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pca_three_positive_loadings_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">pca_three_positive_loadings_pf_weights</span> <span class="o">=</span> <span class="n">pca_three_positive_loadings_pf_weights</span><span class="o">.</span><span class="n">pca_3</span><span class="o">.</span><span class="n">values</span>

    <span class="n">pca_three_negative_loadings</span> <span class="o">=</span> <span class="n">pca_three_df</span><span class="p">[</span><span class="n">pca_three_df</span><span class="o">.</span><span class="n">pca_3</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span>
    <span class="n">pca_three_negative_loadings_pf_tickers</span> <span class="o">=</span> <span class="n">pca_three_negative_loadings</span><span class="o">.</span><span class="n">index</span><span class="p">[(</span><span class="n">pca_three_negative_loadings</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">n_assets</span><span class="p">)</span><span class="o">.</span><span class="n">pca_3</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">tickers_in_portfolio_pca_three_negative</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="n">pca_three_negative_loadings_pf_tickers</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">pca_three_negative_loadings_pf_weights</span> <span class="o">=</span> <span class="n">pca_three_negative_loadings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pca_three_negative_loadings_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span> <span class="o">/</span> <span class="n">pca_three_negative_loadings</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pca_three_negative_loadings_pf_tickers</span><span class="p">]</span><span class="o">.</span><span class="n">abs</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">pca_three_negative_loadings_pf_weights</span> <span class="o">=</span> <span class="n">pca_three_negative_loadings_pf_weights</span><span class="o">.</span><span class="n">pca_3</span><span class="o">.</span><span class="n">values</span>

    <span class="n">pca_three_positive_pf_returns_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">holding_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">pca_three_positive_loadings_pf_tickers</span><span class="p">]</span> <span class="o">*</span> <span class="n">pca_three_positive_loadings_pf_weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">pca_three_negative_pf_returns_tmp</span> <span class="o">=</span> <span class="p">(</span><span class="n">holding_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">pca_three_negative_loadings_pf_tickers</span><span class="p">]</span> <span class="o">*</span> <span class="n">pca_three_negative_loadings_pf_weights</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
    

    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">estimation_period_in_months</span><span class="p">:</span>
        <span class="n">low_first_pca_holding_returns</span> <span class="o">=</span> <span class="n">low_first_pca_holding_returns_tmp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">high_first_pca_holding_returns</span> <span class="o">=</span> <span class="n">high_first_pca_holding_returns_tmp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">pca_two_positive_pf_returns</span> <span class="o">=</span> <span class="n">pca_two_positive_pf_returns_tmp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">pca_two_negative_pf_returns</span> <span class="o">=</span> <span class="n">pca_two_negative_pf_returns_tmp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">pca_three_positive_pf_returns</span> <span class="o">=</span> <span class="n">pca_three_positive_pf_returns_tmp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">pca_three_negative_pf_returns</span> <span class="o">=</span> <span class="n">pca_three_negative_pf_returns_tmp</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">low_first_pca_holding_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">low_first_pca_holding_returns</span><span class="p">,</span> <span class="n">low_first_pca_holding_returns_tmp</span><span class="p">))</span>
        <span class="n">high_first_pca_holding_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">high_first_pca_holding_returns</span><span class="p">,</span> <span class="n">high_first_pca_holding_returns_tmp</span><span class="p">))</span>

        <span class="n">pca_two_positive_pf_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">pca_two_positive_pf_returns</span><span class="p">,</span> <span class="n">pca_two_positive_pf_returns_tmp</span><span class="p">))</span>
        <span class="n">pca_two_negative_pf_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">pca_two_negative_pf_returns</span><span class="p">,</span> <span class="n">pca_two_negative_pf_returns_tmp</span><span class="p">))</span>

        <span class="n">pca_three_positive_pf_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">pca_three_positive_pf_returns</span><span class="p">,</span> <span class="n">pca_three_positive_pf_returns_tmp</span><span class="p">))</span>
        <span class="n">pca_three_negative_pf_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">pca_three_negative_pf_returns</span><span class="p">,</span> <span class="n">pca_three_negative_pf_returns_tmp</span><span class="p">))</span>

<span class="n">buy_and_hold_returns</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">estimation_period_in_months</span><span class="p">]:]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>

<span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span>
    <span class="s2">&quot;Buy and hold&quot;</span><span class="p">:</span> <span class="n">buy_and_hold_returns</span><span class="p">,</span> 
    <span class="s2">&quot;High_PCA1&quot;</span><span class="p">:</span> <span class="n">high_first_pca_holding_returns</span><span class="p">,</span>
    <span class="s2">&quot;Low_PCA1&quot;</span><span class="p">:</span> <span class="n">low_first_pca_holding_returns</span><span class="p">,</span>
    <span class="s2">&quot;Positive_PCA2&quot;</span><span class="p">:</span> <span class="n">pca_two_positive_pf_returns</span><span class="p">,</span>
    <span class="s2">&quot;Negative_PCA2&quot;</span><span class="p">:</span> <span class="n">pca_two_negative_pf_returns</span><span class="p">,</span>
    <span class="s2">&quot;Positive_PCA3&quot;</span><span class="p">:</span> <span class="n">pca_three_positive_pf_returns</span><span class="p">,</span>
    <span class="s2">&quot;Negative_PCA3&quot;</span><span class="p">:</span> <span class="n">pca_three_negative_pf_returns</span>
    <span class="p">})</span>

<span class="n">strategy_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;PCA_1_LS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;High_PCA1&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;Low_PCA1&quot;</span><span class="p">]</span>
<span class="n">strategy_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;PCA_2_LS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;Negative_PCA2&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;Positive_PCA2&quot;</span><span class="p">]</span>
<span class="n">strategy_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;PCA_3_LS&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;Negative_PCA3&quot;</span><span class="p">]</span> <span class="o">-</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;Positive_PCA3&quot;</span><span class="p">]</span>

<span class="n">strategy_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">strategy_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">strategy_results</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="s2">&quot;mean / std&quot;</span><span class="p">]</span>
<span class="n">strategy_results</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>mean / std</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Buy and hold</th>
      <td>0.0005</td>
      <td>0.0122</td>
      <td>0.0433</td>
    </tr>
    <tr>
      <th>High_PCA1</th>
      <td>0.0007</td>
      <td>0.0154</td>
      <td>0.0437</td>
    </tr>
    <tr>
      <th>Low_PCA1</th>
      <td>0.0005</td>
      <td>0.0110</td>
      <td>0.0470</td>
    </tr>
    <tr>
      <th>Positive_PCA2</th>
      <td>0.0001</td>
      <td>0.0162</td>
      <td>0.0033</td>
    </tr>
    <tr>
      <th>Negative_PCA2</th>
      <td>0.0009</td>
      <td>0.0185</td>
      <td>0.0474</td>
    </tr>
    <tr>
      <th>Positive_PCA3</th>
      <td>0.0002</td>
      <td>0.0166</td>
      <td>0.0129</td>
    </tr>
    <tr>
      <th>Negative_PCA3</th>
      <td>0.0008</td>
      <td>0.0147</td>
      <td>0.0513</td>
    </tr>
    <tr>
      <th>PCA_1_LS</th>
      <td>0.0002</td>
      <td>0.0110</td>
      <td>0.0143</td>
    </tr>
    <tr>
      <th>PCA_2_LS</th>
      <td>0.0008</td>
      <td>0.0201</td>
      <td>0.0410</td>
    </tr>
    <tr>
      <th>PCA_3_LS</th>
      <td>0.0005</td>
      <td>0.0162</td>
      <td>0.0332</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>The results show that companies which react more sensitive towards the overall market (measures by the loading of the first principal component) exhibit a higher return but also face higher risk. This is analogue to the CAPM which states that the expected (excess) return of a company can be explained by the sensitivity towards the market portfolio. Notably, the creation of portfolios by the positive and negative loadings lead to portfolios with very different levels of profitability. In our example, the portfolios with negative component loadings have higher returns. In case of component two, higher returns are accompanied by higher risk. A very common approach in finance is to fictionally build long-short positions of portfolios which are build upon the same variable. In our setting, the “variable” is the loading of each principal component which is why we additionally build long-short portfolios per principal component. The output below also exhibits the development of cumulative returns for all portfolios.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">cumulative_returns</span> <span class="o">=</span> <span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">strategy_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">cumulative_returns</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/840ab5dea1307e093c505c124584ad1aaa60e868cd6030a85b390eb9cfc9c2f9.png" src="_images/840ab5dea1307e093c505c124584ad1aaa60e868cd6030a85b390eb9cfc9c2f9.png" />
</div>
</div>
<p>To examine if these portfolios often change their constituents, we take a look at the graphics below which highlight by color if a company is in the portfolio at that time or not. Visually, we can observe that all portfolios are rather stable over time and only slowly exchange their constituents.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tickers_in_portfolio_pca_low</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tickers_in_portfolio_pca_high</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tickers_in_portfolio_pca_two_negative</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tickers_in_portfolio_pca_two_positive</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tickers_in_portfolio_pca_three_negative</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">])</span>
<span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tickers_in_portfolio_pca_three_positive</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">])</span>
<span class="n">x_tick_idx</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">40</span><span class="p">)]</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;PCA 1 - low&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;PCA 1 - high&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;PCA 2 - negative&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;PCA 2 - positive&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;PCA 3 - negative&quot;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">2</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s2">&quot;PCA 3 - positive&quot;</span><span class="p">)</span>

<span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">month_starts</span><span class="p">[</span><span class="n">estimation_period_in_months</span><span class="p">:])</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">month_starts</span><span class="p">[</span><span class="n">estimation_period_in_months</span><span class="p">:])</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x_tick_idx</span><span class="p">)</span>
        <span class="n">axs</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">l</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">study_returns</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_tick_idx</span><span class="p">])</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/f92d328beaa140d0b7950b2d581c7c25d7b19d0396650c469732eb45a0d663fc.png" src="_images/f92d328beaa140d0b7950b2d581c7c25d7b19d0396650c469732eb45a0d663fc.png" />
</div>
</div>
<p>In a next and last step of this analysis, we regress portfolio’s excess returns of the long-shor portfolio upon the Fama-French factors. In comparison, we also conduct this regression with a naive buy and hold portfolio which invests into all assets the same amount of money. The buy and hold portfolio reacts according to its beta parameter estimates almost in line with the market and like a smaller value company. Interestingly, the market beta of the long-short portfolios which are build around the second and third principal component are slightly negative and closer towards zero. This shows that hedging the groups which are build by the signs of principal components works w.r.t the sensitivity towards systematic market movements.</p>
<p>Moreover, at a significance level of 10%, we find the risk adjusted performance to be different to zero for the portfolios of companies with positive loadings of principal component two and three. Furthermore, also the long-short portfolios of principal component two and three seem to exhibit risk-adjusted performance which can not be fully explained by market sensitivity, size and value effects.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1">#from fda_utils.misc import get_ff_factors</span>
<span class="kn">import</span> <span class="nn">statsmodels.api</span> <span class="k">as</span> <span class="nn">sm</span>

<span class="n">ff</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/ff_data.csv&quot;</span><span class="p">)</span>
<span class="n">ff</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">(</span><span class="n">ff</span><span class="o">.</span><span class="n">date</span><span class="p">)</span>
<span class="n">ff</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">regression_data</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">portfolios</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Buy and hold&#39;</span><span class="p">,</span> <span class="s1">&#39;High_PCA1&#39;</span><span class="p">,</span> <span class="s1">&#39;Low_PCA1&#39;</span><span class="p">,</span> <span class="s1">&#39;Positive_PCA2&#39;</span><span class="p">,</span> <span class="s1">&#39;Negative_PCA2&#39;</span><span class="p">,</span> <span class="s1">&#39;Positive_PCA3&#39;</span><span class="p">,</span> <span class="s1">&#39;Negative_PCA3&#39;</span><span class="p">,</span> <span class="s2">&quot;PCA_1_LS&quot;</span><span class="p">,</span> <span class="s2">&quot;PCA_2_LS&quot;</span><span class="p">,</span> <span class="s2">&quot;PCA_3_LS&quot;</span><span class="p">]</span> 

<span class="n">index_names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">portfolios</span><span class="p">:</span>
    <span class="n">index_names</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;estimates&quot;</span><span class="p">))</span>
    <span class="n">index_names</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;p_value&quot;</span><span class="p">))</span>

<span class="n">parameter_estimates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">index_names</span><span class="p">),</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_m&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_smb&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_hml&quot;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">pf_name</span> <span class="ow">in</span> <span class="n">portfolios</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">regression_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">pf_name</span><span class="p">]</span> <span class="o">-</span> <span class="n">regression_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;rf&quot;</span><span class="p">]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">regression_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;Mkt-RF&quot;</span><span class="p">,</span> <span class="s2">&quot;SMB&quot;</span><span class="p">,</span> <span class="s2">&quot;HML&quot;</span><span class="p">]]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cov_type</span> <span class="o">=</span> <span class="s2">&quot;HC3&quot;</span><span class="p">)</span>
    <span class="n">parameter_estimates</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">pf_name</span><span class="p">,</span> <span class="s2">&quot;estimates&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">values</span>
    <span class="n">parameter_estimates</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">pf_name</span><span class="p">,</span> <span class="s2">&quot;p_value&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">pvalues</span><span class="o">.</span><span class="n">values</span>

<span class="n">parameter_estimates</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>alpha</th>
      <th>beta_m</th>
      <th>beta_smb</th>
      <th>beta_hml</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Buy and hold</th>
      <th>estimates</th>
      <td>0.000071</td>
      <td>0.92159</td>
      <td>0.25897</td>
      <td>0.307266</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.207542</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">High_PCA1</th>
      <th>estimates</th>
      <td>0.000134</td>
      <td>1.150078</td>
      <td>0.113088</td>
      <td>0.577135</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.132407</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Low_PCA1</th>
      <th>estimates</th>
      <td>0.000152</td>
      <td>0.682292</td>
      <td>0.259777</td>
      <td>0.080291</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.326194</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.000498</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Positive_PCA2</th>
      <th>estimates</th>
      <td>-0.000519</td>
      <td>1.038134</td>
      <td>0.01091</td>
      <td>0.323957</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.028789</td>
      <td>0.0</td>
      <td>0.880513</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Negative_PCA2</th>
      <th>estimates</th>
      <td>0.000454</td>
      <td>1.006439</td>
      <td>0.382356</td>
      <td>0.672203</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.104505</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Positive_PCA3</th>
      <th>estimates</th>
      <td>-0.000409</td>
      <td>1.08431</td>
      <td>0.266986</td>
      <td>-0.089409</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.062293</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.016103</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Negative_PCA3</th>
      <th>estimates</th>
      <td>0.000273</td>
      <td>0.956621</td>
      <td>-0.024046</td>
      <td>0.268424</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.182876</td>
      <td>0.0</td>
      <td>0.494493</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">PCA_1_LS</th>
      <th>estimates</th>
      <td>-0.000089</td>
      <td>0.46781</td>
      <td>-0.146376</td>
      <td>0.496946</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.655117</td>
      <td>0.0</td>
      <td>0.000237</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">PCA_2_LS</th>
      <th>estimates</th>
      <td>0.000902</td>
      <td>-0.031671</td>
      <td>0.371759</td>
      <td>0.348349</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.055714</td>
      <td>0.717789</td>
      <td>0.0063</td>
      <td>0.001132</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">PCA_3_LS</th>
      <th>estimates</th>
      <td>0.000611</td>
      <td>-0.127665</td>
      <td>-0.290719</td>
      <td>0.357936</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.096807</td>
      <td>0.006967</td>
      <td>0.000011</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>When doing regression analysis above it is more common to use monthly returns instead of daily returns. These are less noisy, however, due to the reduction in the data size statistical uncertainty is increased. In the cells below, we convert daily returns to log-returns, aggregate these to monthly log-returns and convert them back to monthly discrete returns. The first output exhibits mean, standard deviation and mean to standard deviation for monthly returns. The second output, the Fama-French regressions of the risk-adjusted performance for the principal component loading portfolios. Results partly differ, however, we still examine differences in the portfolios. As an exercise, try to interpret these results in more detail.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">monthly_strategy_returns</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;ME&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">monthly_strategy_returns</span> <span class="o">=</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m&quot;</span><span class="p">)</span>

<span class="n">monthly_strategy_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">monthly_strategy_results</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="s2">&quot;mean / std&quot;</span><span class="p">]</span>
<span class="n">monthly_strategy_results</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>mean / std</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Buy and hold</th>
      <td>0.0110</td>
      <td>0.0543</td>
      <td>0.2018</td>
    </tr>
    <tr>
      <th>High_PCA1</th>
      <td>0.0135</td>
      <td>0.0609</td>
      <td>0.2210</td>
    </tr>
    <tr>
      <th>Low_PCA1</th>
      <td>0.0107</td>
      <td>0.0483</td>
      <td>0.2208</td>
    </tr>
    <tr>
      <th>Positive_PCA2</th>
      <td>0.0018</td>
      <td>0.0794</td>
      <td>0.0228</td>
    </tr>
    <tr>
      <th>Negative_PCA2</th>
      <td>0.0179</td>
      <td>0.0830</td>
      <td>0.2151</td>
    </tr>
    <tr>
      <th>Positive_PCA3</th>
      <td>0.0045</td>
      <td>0.0762</td>
      <td>0.0596</td>
    </tr>
    <tr>
      <th>Negative_PCA3</th>
      <td>0.0148</td>
      <td>0.0504</td>
      <td>0.2932</td>
    </tr>
    <tr>
      <th>PCA_1_LS</th>
      <td>0.0029</td>
      <td>0.0415</td>
      <td>0.0698</td>
    </tr>
    <tr>
      <th>PCA_2_LS</th>
      <td>0.0175</td>
      <td>0.0994</td>
      <td>0.1761</td>
    </tr>
    <tr>
      <th>PCA_3_LS</th>
      <td>0.0106</td>
      <td>0.0659</td>
      <td>0.1612</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_monthly</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/ff_monthly.csv&quot;</span><span class="p">)</span>
<span class="n">ff_monthly</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ff_monthly</span><span class="o">.</span><span class="n">date</span>
<span class="n">ff_monthly</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">monthly_regression_data</span> <span class="o">=</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ff_monthly</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="n">index_names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">portfolios</span><span class="p">:</span>
    <span class="n">index_names</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;estimates&quot;</span><span class="p">))</span>
    <span class="n">index_names</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;p_value&quot;</span><span class="p">))</span>

<span class="n">parameter_estimates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">index_names</span><span class="p">),</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_m&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_smb&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_hml&quot;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">pf_name</span> <span class="ow">in</span> <span class="n">portfolios</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">monthly_regression_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">pf_name</span><span class="p">]</span> <span class="o">-</span> <span class="n">monthly_regression_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;rf&quot;</span><span class="p">]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">monthly_regression_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;Mkt-RF&quot;</span><span class="p">,</span> <span class="s2">&quot;SMB&quot;</span><span class="p">,</span> <span class="s2">&quot;HML&quot;</span><span class="p">]]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cov_type</span><span class="o">=</span><span class="s2">&quot;HAC&quot;</span><span class="p">,</span> <span class="n">cov_kwds</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;maxlags&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">})</span> 
    <span class="n">parameter_estimates</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">pf_name</span><span class="p">,</span> <span class="s2">&quot;estimates&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">values</span>
    <span class="n">parameter_estimates</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">pf_name</span><span class="p">,</span> <span class="s2">&quot;p_value&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">pvalues</span><span class="o">.</span><span class="n">values</span>

<span class="n">parameter_estimates</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>alpha</th>
      <th>beta_m</th>
      <th>beta_smb</th>
      <th>beta_hml</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Buy and hold</th>
      <th>estimates</th>
      <td>0.000923</td>
      <td>0.996004</td>
      <td>0.263844</td>
      <td>0.295237</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.301719</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">High_PCA1</th>
      <th>estimates</th>
      <td>0.002343</td>
      <td>1.117456</td>
      <td>0.076787</td>
      <td>0.438687</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.140535</td>
      <td>0.0</td>
      <td>0.268458</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Low_PCA1</th>
      <th>estimates</th>
      <td>0.00306</td>
      <td>0.720275</td>
      <td>0.346073</td>
      <td>0.0603</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.438454</td>
      <td>0.0</td>
      <td>0.002659</td>
      <td>0.542107</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Positive_PCA2</th>
      <th>estimates</th>
      <td>-0.009691</td>
      <td>1.163879</td>
      <td>0.149106</td>
      <td>0.699541</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.092404</td>
      <td>0.0</td>
      <td>0.496878</td>
      <td>0.003255</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Negative_PCA2</th>
      <th>estimates</th>
      <td>0.007912</td>
      <td>1.074546</td>
      <td>0.387754</td>
      <td>0.404322</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.139734</td>
      <td>0.0</td>
      <td>0.117431</td>
      <td>0.065879</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Positive_PCA3</th>
      <th>estimates</th>
      <td>-0.007987</td>
      <td>1.220097</td>
      <td>0.647601</td>
      <td>0.130128</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.024506</td>
      <td>0.0</td>
      <td>0.000001</td>
      <td>0.342062</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">Negative_PCA3</th>
      <th>estimates</th>
      <td>0.005658</td>
      <td>0.815248</td>
      <td>-0.26509</td>
      <td>0.179325</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.037814</td>
      <td>0.0</td>
      <td>0.060412</td>
      <td>0.069914</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">PCA_1_LS</th>
      <th>estimates</th>
      <td>-0.002124</td>
      <td>0.398506</td>
      <td>-0.253707</td>
      <td>0.370557</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.600679</td>
      <td>0.000002</td>
      <td>0.102287</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">PCA_2_LS</th>
      <th>estimates</th>
      <td>0.017914</td>
      <td>-0.142529</td>
      <td>0.207072</td>
      <td>-0.345373</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.115298</td>
      <td>0.573346</td>
      <td>0.64624</td>
      <td>0.483973</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">PCA_3_LS</th>
      <th>estimates</th>
      <td>0.012741</td>
      <td>-0.440779</td>
      <td>-0.887311</td>
      <td>-0.019303</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.022729</td>
      <td>0.000063</td>
      <td>0.000041</td>
      <td>0.936731</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<section id="cluster-portfolios-by-pca-loadings">
<h3>Cluster portfolios by pca loadings<a class="headerlink" href="#cluster-portfolios-by-pca-loadings" title="Link to this heading">#</a></h3>
<p>In the last analysis, we created portfolios which were selected according the the loadings of a single principal component. The idea was that for a principal component companies with different sign are likely to exhibit different systematic behavior. In the following analysis, we aim to construct portfolios according to the vector of loadings for <span class="math notranslate nohighlight">\(k\)</span> principal components for each company.</p>
<p>The cell below illustrates these vectors for a given estimation period and if we use the loadings of the first three principal components per company. Just regarding the sign of the loadings for the first five observations, we would group the companies “A” and “AAL” into one group, the companies “AAP” and “AAPL” and leave “AA” alone as its own group. Differences of the company loading vectors imply an overall different systematic behavior of these companies.</p>
<p>To objectively group the companies according to their component loadings into a user-specified number of groups, we can make use of clustering, e.g., k-means clustering.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>

<span class="n">estimation_period_in_months</span> <span class="o">=</span> <span class="mi">24</span>

<span class="n">month_starts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;2015-01-01&quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;2024-06-01&quot;</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="s2">&quot;MS&quot;</span><span class="p">)</span>
<span class="n">month_ends</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;2015-01-01&quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;2024-07-01&quot;</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="s2">&quot;ME&quot;</span><span class="p">)</span>

<span class="n">t</span> <span class="o">=</span> <span class="mi">24</span>
<span class="c1">#for t in tqdm(range(estimation_period_in_months, len(month_starts), 1)):</span>
<span class="n">estimation_data</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="n">estimation_period_in_months</span><span class="p">]:</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span>
<span class="n">holding_data</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">]:</span><span class="n">month_ends</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span>

<span class="n">na_per_ticker</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">available_tickers</span> <span class="o">=</span> <span class="n">na_per_ticker</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">na_per_ticker</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">estimation_data</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">available_tickers</span><span class="p">]</span>
<span class="n">holding_data</span> <span class="o">=</span> <span class="n">holding_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">available_tickers</span><span class="p">]</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">estimation_data</span><span class="p">)</span>
<span class="n">estimation_data_s</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">estimation_data</span><span class="p">)</span>

<span class="n">n_components</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">n_components</span><span class="p">,</span> <span class="n">svd_solver</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span>
<span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">estimation_data_s</span><span class="p">)</span>

<span class="n">pca_loadings_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">index</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;pca_loading_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_components</span><span class="p">)])</span>
<span class="n">pca_loadings_df</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>pca_loading_0</th>
      <th>pca_loading_1</th>
      <th>pca_loading_2</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>A</th>
      <td>-0.050345</td>
      <td>0.006911</td>
      <td>-0.024857</td>
    </tr>
    <tr>
      <th>AA</th>
      <td>-0.033943</td>
      <td>0.039440</td>
      <td>0.050863</td>
    </tr>
    <tr>
      <th>AAL</th>
      <td>-0.034161</td>
      <td>0.007631</td>
      <td>-0.039854</td>
    </tr>
    <tr>
      <th>AAP</th>
      <td>-0.028500</td>
      <td>-0.007573</td>
      <td>-0.013412</td>
    </tr>
    <tr>
      <th>AAPL</th>
      <td>-0.036238</td>
      <td>-0.004437</td>
      <td>-0.022869</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>For a simpler visual illustration we restrict ourselves to the first two loadings per company. The left graphic in the figure below shows, how the companies would be split into four clusters when we set the number of clusters to four. As we want to hold companies in our loading portfolios which exhibit different systematic behavior, we further adjust the portfolio selection process. For every cluster, we only hold <span class="math notranslate nohighlight">\(n_{\text{assets}}\)</span> which are selected by the highest silhouette score in their cluster. Companies in these portfolios can be seen in the right graphic of the figure below.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">silhouette_samples</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="n">estimation_period_in_months</span> <span class="o">=</span> <span class="mi">24</span>

<span class="n">month_starts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;2015-01-01&quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;2024-06-01&quot;</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="s2">&quot;MS&quot;</span><span class="p">)</span>
<span class="n">month_ends</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;2015-01-01&quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;2024-07-01&quot;</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="s2">&quot;ME&quot;</span><span class="p">)</span>

<span class="n">t</span> <span class="o">=</span> <span class="mi">24</span>
<span class="c1">#for t in tqdm(range(estimation_period_in_months, len(month_starts), 1)):</span>
<span class="n">estimation_data</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="n">estimation_period_in_months</span><span class="p">]:</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span>
<span class="n">holding_data</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">]:</span><span class="n">month_ends</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span>

<span class="n">na_per_ticker</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">available_tickers</span> <span class="o">=</span> <span class="n">na_per_ticker</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">na_per_ticker</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
<span class="n">estimation_data</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">available_tickers</span><span class="p">]</span>
<span class="n">holding_data</span> <span class="o">=</span> <span class="n">holding_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">available_tickers</span><span class="p">]</span>

<span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">estimation_data</span><span class="p">)</span>
<span class="n">estimation_data_s</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">estimation_data</span><span class="p">)</span>

<span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">svd_solver</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span>
<span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">estimation_data_s</span><span class="p">)</span>

<span class="n">pca_loadings_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="o">.</span><span class="n">transpose</span><span class="p">()[:,</span> <span class="p">:</span><span class="mi">2</span><span class="p">],</span> <span class="n">index</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pca_loading_one&quot;</span><span class="p">,</span> <span class="s2">&quot;pca_loading_two&quot;</span><span class="p">])</span>

<span class="n">cluster_scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
<span class="n">cluster_data</span> <span class="o">=</span> <span class="n">cluster_scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">pca_loadings_df</span><span class="p">)</span>

<span class="n">n_clusters</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">n_companies_pf</span> <span class="o">=</span> <span class="mi">50</span>
<span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span>
<span class="n">kmeans</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cluster_data</span><span class="p">)</span>

<span class="n">pca_loadings_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;cluster_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">labels_</span>
<span class="n">pca_loadings_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;silhouette_samples&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">silhouette_samples</span><span class="p">(</span><span class="n">cluster_data</span><span class="p">,</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">labels_</span><span class="p">)</span>
<span class="n">pca_loadings_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;pf_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">):</span>
    <span class="n">pca_loadings_cluster</span> <span class="o">=</span> <span class="n">pca_loadings_df</span><span class="p">[</span><span class="n">pca_loadings_df</span><span class="o">.</span><span class="n">cluster_labels</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span>
    <span class="n">pca_loadings_tickers</span> <span class="o">=</span> <span class="n">pca_loadings_cluster</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">pca_loadings_cluster</span><span class="o">.</span><span class="n">silhouette_samples</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">n_companies_pf</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">pca_loadings_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pca_loadings_tickers</span><span class="p">,</span> <span class="s2">&quot;pf_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

<span class="c1"># Create a scatter plot using matplotlib</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">pca_loadings_df</span><span class="p">,</span> 
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;pca_loading_one&#39;</span><span class="p">,</span> 
    <span class="n">y</span><span class="o">=</span><span class="s1">&#39;pca_loading_two&#39;</span><span class="p">,</span> 
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
    <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;cluster_labels&#39;</span><span class="p">,</span> 
    <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> 
    <span class="n">legend</span><span class="o">=</span><span class="s1">&#39;full&#39;</span>
<span class="p">)</span>

<span class="n">sns</span><span class="o">.</span><span class="n">scatterplot</span><span class="p">(</span>
    <span class="n">data</span><span class="o">=</span><span class="n">pca_loadings_df</span><span class="p">,</span> 
    <span class="n">x</span><span class="o">=</span><span class="s1">&#39;pca_loading_one&#39;</span><span class="p">,</span> 
    <span class="n">y</span><span class="o">=</span><span class="s1">&#39;pca_loading_two&#39;</span><span class="p">,</span> 
    <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
    <span class="n">hue</span><span class="o">=</span><span class="s1">&#39;pf_labels&#39;</span><span class="p">,</span> 
    <span class="n">palette</span><span class="o">=</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> 
    <span class="n">legend</span><span class="o">=</span><span class="s1">&#39;full&#39;</span>
<span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;PCA Loading One&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;PCA Loading Two&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;PCA Loadings Scatter Plot by Cluster Labels&#39;</span><span class="p">)</span>

<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;PCA Loading One&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;PCA Loading Two&#39;</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Portfolios by cluster and highest silhouette score&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/c073aa8dfd4b2619c51cd6fc32f952fa7e8423330db312dc536efbdc9eae7679.png" src="_images/c073aa8dfd4b2619c51cd6fc32f952fa7e8423330db312dc536efbdc9eae7679.png" />
</div>
</div>
<p>Let us examine which portfolios are created if we conduct the following sorting mechanism over time:</p>
<ol class="arabic simple">
<li><p>Use daily data from the last <span class="math notranslate nohighlight">\(M\)</span> months to estimate <span class="math notranslate nohighlight">\(k\)</span> principal components (only for companies whose data is fully available during that time)</p></li>
<li><p>Sort all companies into <span class="math notranslate nohighlight">\(c\)</span> clusters by using the principal component loadings per company. To ensure cluster consistency, only initialize the cluster centers for the first estimation period randomly and use the cluster centers of the last estimation as starting values for the current period afterwards.</p></li>
<li><p>For each cluster select companies into the cluster portfolio, if <span class="math notranslate nohighlight">\(rg \left( S(i) \right) &lt; n_{\text{assets}}\)</span>; if the number of companies is smaller than <span class="math notranslate nohighlight">\(n_{\text{assets}}\)</span>, use the full cluster.</p></li>
<li><p>Hold these portfolio with equal weights for <span class="math notranslate nohighlight">\(H\)</span> months.</p></li>
</ol>
<p>The cell below proceeds as described using <span class="math notranslate nohighlight">\(M = 24\)</span>, <span class="math notranslate nohighlight">\(k = 5\)</span>, <span class="math notranslate nohighlight">\(c = 4\)</span> and <span class="math notranslate nohighlight">\(n_{\text{assets}} = 50\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">silhouette_samples</span>


<span class="n">estimation_period_in_months</span> <span class="o">=</span> <span class="mi">24</span>

<span class="n">month_starts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;2015-01-01&quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;2024-06-01&quot;</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="s2">&quot;MS&quot;</span><span class="p">)</span>
<span class="n">month_ends</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;2015-01-01&quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;2024-07-01&quot;</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="s2">&quot;ME&quot;</span><span class="p">)</span>

<span class="n">standardize_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">n_clusters</span> <span class="o">=</span> <span class="mi">4</span>
<span class="n">n_companies_pf</span> <span class="o">=</span> <span class="mi">50</span>

<span class="n">cluster_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">estimation_period_in_months</span><span class="p">]:,</span> <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cluster_pf_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">)])</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">estimation_period_in_months</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">month_starts</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">estimation_data</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="n">estimation_period_in_months</span><span class="p">]:</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span>
    <span class="n">holding_data</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">]:</span><span class="n">month_ends</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span>

    <span class="n">na_per_ticker</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">available_tickers</span> <span class="o">=</span> <span class="n">na_per_ticker</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">na_per_ticker</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">estimation_data</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">available_tickers</span><span class="p">]</span>
    <span class="n">holding_data</span> <span class="o">=</span> <span class="n">holding_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">available_tickers</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">standardize_data</span><span class="p">:</span>
        <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">estimation_data</span><span class="p">)</span>
        <span class="n">estimation_data_s</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">estimation_data</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">estimation_data_s</span> <span class="o">=</span> <span class="n">estimation_data</span> <span class="o">-</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

    <span class="n">n_components</span> <span class="o">=</span> <span class="mi">5</span>
    <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="n">n_components</span><span class="p">,</span> <span class="n">svd_solver</span> <span class="o">=</span> <span class="s2">&quot;full&quot;</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span>
    <span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">estimation_data_s</span><span class="p">)</span>

    <span class="n">pca_loadings_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pca</span><span class="o">.</span><span class="n">components_</span><span class="o">.</span><span class="n">transpose</span><span class="p">(),</span> <span class="n">index</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;pca_loadings</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_components</span><span class="p">)])</span>

    <span class="n">cluster_scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">cluster_data</span> <span class="o">=</span> <span class="n">cluster_scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">pca_loadings_df</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">estimation_period_in_months</span><span class="p">:</span>
        <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cluster_center_init</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">cluster_centers_</span>
        <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">init</span> <span class="o">=</span> <span class="n">cluster_center_init</span><span class="p">)</span>
    <span class="n">kmeans</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cluster_data</span><span class="p">)</span>

    <span class="n">pca_loadings_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;cluster_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">labels_</span>
    <span class="n">pca_loadings_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;silhouette_samples&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">silhouette_samples</span><span class="p">(</span><span class="n">cluster_data</span><span class="p">,</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">labels_</span><span class="p">)</span>
    <span class="n">pca_loadings_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;pf_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="n">n_companies_per_cluster</span> <span class="o">=</span> <span class="n">pca_loadings_df</span><span class="o">.</span><span class="n">cluster_labels</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">pf_sizes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">):</span>
        <span class="n">cluster_pf_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_companies_per_cluster</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">n_companies_pf</span><span class="p">)</span>
        <span class="n">pf_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_pf_size</span>
        <span class="c1">#if cluster_pf_size &lt; n_companies_pf:</span>
            <span class="c1">#print(f&quot;Number of companies in portfolio for cluster {i} from {estimation_data.index[0]} to {estimation_data.index[-1]} is {cluster_pf_size} instead of {n_companies_pf}&quot;)</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">):</span>
        <span class="n">pca_loadings_cluster</span> <span class="o">=</span> <span class="n">pca_loadings_df</span><span class="p">[</span><span class="n">pca_loadings_df</span><span class="o">.</span><span class="n">cluster_labels</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span>
        <span class="n">pca_loadings_tickers</span> <span class="o">=</span> <span class="n">pca_loadings_cluster</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">pca_loadings_cluster</span><span class="o">.</span><span class="n">silhouette_samples</span><span class="o">.</span><span class="n">rank</span><span class="p">(</span><span class="n">method</span> <span class="o">=</span> <span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">pf_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
        <span class="n">pca_loadings_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pca_loadings_tickers</span><span class="p">,</span> <span class="s2">&quot;pf_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>
        <span class="n">cluster_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">holding_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cluster_pf_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">holding_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">pca_loadings_df</span><span class="p">[</span><span class="n">pca_loadings_df</span><span class="o">.</span><span class="n">pf_labels</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output traceback highlight-ipythontb notranslate"><div class="highlight"><pre><span></span><span class="gt">---------------------------------------------------------------------------</span>
<span class="ne">KeyboardInterrupt</span><span class="g g-Whitespace">                         </span>Traceback (most recent call last)
<span class="n">Cell</span> <span class="n">In</span><span class="p">[</span><span class="mi">16</span><span class="p">],</span> <span class="n">line</span> <span class="mi">51</span>
<span class="g g-Whitespace">     </span><span class="mi">48</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cluster_data</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">50</span> <span class="n">pca_loadings_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;cluster_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">labels_</span>
<span class="ne">---&gt; </span><span class="mi">51</span> <span class="n">pca_loadings_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;silhouette_samples&quot;</span><span class="p">]</span> <span class="o">=</span>  <span class="n">silhouette_samples</span><span class="p">(</span><span class="n">cluster_data</span><span class="p">,</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">labels_</span><span class="p">)</span>
<span class="g g-Whitespace">     </span><span class="mi">52</span> <span class="n">pca_loadings_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;pf_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
<span class="g g-Whitespace">     </span><span class="mi">54</span> <span class="n">n_companies_per_cluster</span> <span class="o">=</span> <span class="n">pca_loadings_df</span><span class="o">.</span><span class="n">cluster_labels</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>

<span class="nn">File ~/Library/Mobile Documents/com~apple~CloudDocs/Kurse/FDAML/.venv/lib/python3.12/site-packages/sklearn/utils/_param_validation.py:213,</span> in <span class="ni">validate_params.&lt;locals&gt;.decorator.&lt;locals&gt;.wrapper</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span> <span class="k">try</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">208</span>     <span class="k">with</span> <span class="n">config_context</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">209</span>         <span class="n">skip_parameter_validation</span><span class="o">=</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span>             <span class="n">prefer_skip_nested_validation</span> <span class="ow">or</span> <span class="n">global_skip_validation</span>
<span class="g g-Whitespace">    </span><span class="mi">211</span>         <span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">212</span>     <span class="p">):</span>
<span class="ne">--&gt; </span><span class="mi">213</span>         <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">214</span> <span class="k">except</span> <span class="n">InvalidParameterError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">215</span>     <span class="c1"># When the function is just a wrapper around an estimator, we allow</span>
<span class="g g-Whitespace">    </span><span class="mi">216</span>     <span class="c1"># the function to delegate validation to the estimator, but we replace</span>
<span class="g g-Whitespace">    </span><span class="mi">217</span>     <span class="c1"># the name of the estimator by the name of the function in the error</span>
<span class="g g-Whitespace">    </span><span class="mi">218</span>     <span class="c1"># message to avoid confusion.</span>
<span class="g g-Whitespace">    </span><span class="mi">219</span>     <span class="n">msg</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">220</span>         <span class="sa">r</span><span class="s2">&quot;parameter of \w+ must be&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">221</span>         <span class="sa">f</span><span class="s2">&quot;parameter of </span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__qualname__</span><span class="si">}</span><span class="s2"> must be&quot;</span><span class="p">,</span>
<span class="g g-Whitespace">    </span><span class="mi">222</span>         <span class="nb">str</span><span class="p">(</span><span class="n">e</span><span class="p">),</span>
<span class="g g-Whitespace">    </span><span class="mi">223</span>     <span class="p">)</span>

<span class="nn">File ~/Library/Mobile Documents/com~apple~CloudDocs/Kurse/FDAML/.venv/lib/python3.12/site-packages/sklearn/metrics/cluster/_unsupervised.py:303,</span> in <span class="ni">silhouette_samples</span><span class="nt">(X, labels, metric, **kwds)</span>
<span class="g g-Whitespace">    </span><span class="mi">299</span> <span class="n">kwds</span><span class="p">[</span><span class="s2">&quot;metric&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">metric</span>
<span class="g g-Whitespace">    </span><span class="mi">300</span> <span class="n">reduce_func</span> <span class="o">=</span> <span class="n">functools</span><span class="o">.</span><span class="n">partial</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">301</span>     <span class="n">_silhouette_reduce</span><span class="p">,</span> <span class="n">labels</span><span class="o">=</span><span class="n">labels</span><span class="p">,</span> <span class="n">label_freqs</span><span class="o">=</span><span class="n">label_freqs</span>
<span class="g g-Whitespace">    </span><span class="mi">302</span> <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">303</span> <span class="n">results</span> <span class="o">=</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">pairwise_distances_chunked</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">reduce_func</span><span class="o">=</span><span class="n">reduce_func</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">))</span>
<span class="g g-Whitespace">    </span><span class="mi">304</span> <span class="n">intra_clust_dists</span><span class="p">,</span> <span class="n">inter_clust_dists</span> <span class="o">=</span> <span class="n">results</span>
<span class="g g-Whitespace">    </span><span class="mi">305</span> <span class="n">intra_clust_dists</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">intra_clust_dists</span><span class="p">)</span>

<span class="nn">File ~/Library/Mobile Documents/com~apple~CloudDocs/Kurse/FDAML/.venv/lib/python3.12/site-packages/sklearn/metrics/pairwise.py:2144,</span> in <span class="ni">pairwise_distances_chunked</span><span class="nt">(X, Y, reduce_func, metric, n_jobs, working_memory, **kwds)</span>
<span class="g g-Whitespace">   </span><span class="mi">2142</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">2143</span>     <span class="n">X_chunk</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">sl</span><span class="p">]</span>
<span class="ne">-&gt; </span><span class="mi">2144</span> <span class="n">D_chunk</span> <span class="o">=</span> <span class="n">pairwise_distances</span><span class="p">(</span><span class="n">X_chunk</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="n">n_jobs</span><span class="o">=</span><span class="n">n_jobs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">2145</span> <span class="k">if</span> <span class="p">(</span><span class="n">X</span> <span class="ow">is</span> <span class="n">Y</span> <span class="ow">or</span> <span class="n">Y</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="n">PAIRWISE_DISTANCE_FUNCTIONS</span><span class="o">.</span><span class="n">get</span><span class="p">(</span>
<span class="g g-Whitespace">   </span><span class="mi">2146</span>     <span class="n">metric</span><span class="p">,</span> <span class="kc">None</span>
<span class="g g-Whitespace">   </span><span class="mi">2147</span> <span class="p">)</span> <span class="ow">is</span> <span class="n">euclidean_distances</span><span class="p">:</span>
<span class="g g-Whitespace">   </span><span class="mi">2148</span>     <span class="c1"># zeroing diagonal, taking care of aliases of &quot;euclidean&quot;,</span>
<span class="g g-Whitespace">   </span><span class="mi">2149</span>     <span class="c1"># i.e. &quot;l2&quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">2150</span>     <span class="n">D_chunk</span><span class="o">.</span><span class="n">flat</span><span class="p">[</span><span class="n">sl</span><span class="o">.</span><span class="n">start</span> <span class="p">::</span> <span class="n">_num_samples</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

<span class="nn">File ~/Library/Mobile Documents/com~apple~CloudDocs/Kurse/FDAML/.venv/lib/python3.12/site-packages/sklearn/utils/_param_validation.py:186,</span> in <span class="ni">validate_params.&lt;locals&gt;.decorator.&lt;locals&gt;.wrapper</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">184</span> <span class="n">global_skip_validation</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()[</span><span class="s2">&quot;skip_parameter_validation&quot;</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">185</span> <span class="k">if</span> <span class="n">global_skip_validation</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">186</span>     <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">188</span> <span class="n">func_sig</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">190</span> <span class="c1"># Map *args/**kwargs to the function signature</span>

<span class="nn">File ~/Library/Mobile Documents/com~apple~CloudDocs/Kurse/FDAML/.venv/lib/python3.12/site-packages/sklearn/metrics/pairwise.py:2331,</span> in <span class="ni">pairwise_distances</span><span class="nt">(X, Y, metric, n_jobs, force_all_finite, **kwds)</span>
<span class="g g-Whitespace">   </span><span class="mi">2328</span>         <span class="k">return</span> <span class="n">distance</span><span class="o">.</span><span class="n">squareform</span><span class="p">(</span><span class="n">distance</span><span class="o">.</span><span class="n">pdist</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">))</span>
<span class="g g-Whitespace">   </span><span class="mi">2329</span>     <span class="n">func</span> <span class="o">=</span> <span class="n">partial</span><span class="p">(</span><span class="n">distance</span><span class="o">.</span><span class="n">cdist</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="n">metric</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
<span class="ne">-&gt; </span><span class="mi">2331</span> <span class="k">return</span> <span class="n">_parallel_pairwise</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">n_jobs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>

<span class="nn">File ~/Library/Mobile Documents/com~apple~CloudDocs/Kurse/FDAML/.venv/lib/python3.12/site-packages/sklearn/metrics/pairwise.py:1871,</span> in <span class="ni">_parallel_pairwise</span><span class="nt">(X, Y, func, n_jobs, **kwds)</span>
<span class="g g-Whitespace">   </span><span class="mi">1868</span> <span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">dtype</span> <span class="o">=</span> <span class="n">_return_float_dtype</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1870</span> <span class="k">if</span> <span class="n">effective_n_jobs</span><span class="p">(</span><span class="n">n_jobs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
<span class="ne">-&gt; </span><span class="mi">1871</span>     <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">)</span>
<span class="g g-Whitespace">   </span><span class="mi">1873</span> <span class="c1"># enforce a threading backend to prevent data communication overhead</span>
<span class="g g-Whitespace">   </span><span class="mi">1874</span> <span class="n">fd</span> <span class="o">=</span> <span class="n">delayed</span><span class="p">(</span><span class="n">_dist_wrapper</span><span class="p">)</span>

<span class="nn">File ~/Library/Mobile Documents/com~apple~CloudDocs/Kurse/FDAML/.venv/lib/python3.12/site-packages/sklearn/utils/_param_validation.py:186,</span> in <span class="ni">validate_params.&lt;locals&gt;.decorator.&lt;locals&gt;.wrapper</span><span class="nt">(*args, **kwargs)</span>
<span class="g g-Whitespace">    </span><span class="mi">184</span> <span class="n">global_skip_validation</span> <span class="o">=</span> <span class="n">get_config</span><span class="p">()[</span><span class="s2">&quot;skip_parameter_validation&quot;</span><span class="p">]</span>
<span class="g g-Whitespace">    </span><span class="mi">185</span> <span class="k">if</span> <span class="n">global_skip_validation</span><span class="p">:</span>
<span class="ne">--&gt; </span><span class="mi">186</span>     <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">188</span> <span class="n">func_sig</span> <span class="o">=</span> <span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">190</span> <span class="c1"># Map *args/**kwargs to the function signature</span>

<span class="nn">File ~/Library/Mobile Documents/com~apple~CloudDocs/Kurse/FDAML/.venv/lib/python3.12/site-packages/sklearn/metrics/pairwise.py:347,</span> in <span class="ni">euclidean_distances</span><span class="nt">(X, Y, Y_norm_squared, squared, X_norm_squared)</span>
<span class="g g-Whitespace">    </span><span class="mi">341</span>     <span class="k">if</span> <span class="n">Y_norm_squared</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
<span class="g g-Whitespace">    </span><span class="mi">342</span>         <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
<span class="g g-Whitespace">    </span><span class="mi">343</span>             <span class="sa">f</span><span class="s2">&quot;Incompatible dimensions for Y of shape </span><span class="si">{</span><span class="n">Y</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2"> and &quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">344</span>             <span class="sa">f</span><span class="s2">&quot;Y_norm_squared of shape </span><span class="si">{</span><span class="n">original_shape</span><span class="si">}</span><span class="s2">.&quot;</span>
<span class="g g-Whitespace">    </span><span class="mi">345</span>         <span class="p">)</span>
<span class="ne">--&gt; </span><span class="mi">347</span> <span class="k">return</span> <span class="n">_euclidean_distances</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">X_norm_squared</span><span class="p">,</span> <span class="n">Y_norm_squared</span><span class="p">,</span> <span class="n">squared</span><span class="p">)</span>

<span class="nn">File ~/Library/Mobile Documents/com~apple~CloudDocs/Kurse/FDAML/.venv/lib/python3.12/site-packages/sklearn/metrics/pairwise.py:382,</span> in <span class="ni">_euclidean_distances</span><span class="nt">(X, Y, X_norm_squared, Y_norm_squared, squared)</span>
<span class="g g-Whitespace">    </span><span class="mi">379</span>     <span class="n">distances</span> <span class="o">=</span> <span class="n">_euclidean_distances_upcast</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">XX</span><span class="p">,</span> <span class="n">Y</span><span class="p">,</span> <span class="n">YY</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">380</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">381</span>     <span class="c1"># if dtype is already float64, no need to chunk and upcast</span>
<span class="ne">--&gt; </span><span class="mi">382</span>     <span class="n">distances</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span> <span class="o">*</span> <span class="n">safe_sparse_dot</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">Y</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">dense_output</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">383</span>     <span class="n">distances</span> <span class="o">+=</span> <span class="n">XX</span>
<span class="g g-Whitespace">    </span><span class="mi">384</span>     <span class="n">distances</span> <span class="o">+=</span> <span class="n">YY</span>

<span class="nn">File ~/Library/Mobile Documents/com~apple~CloudDocs/Kurse/FDAML/.venv/lib/python3.12/site-packages/sklearn/utils/extmath.py:211,</span> in <span class="ni">safe_sparse_dot</span><span class="nt">(a, b, dense_output)</span>
<span class="g g-Whitespace">    </span><span class="mi">207</span> <span class="k">else</span><span class="p">:</span>
<span class="g g-Whitespace">    </span><span class="mi">208</span>     <span class="n">ret</span> <span class="o">=</span> <span class="n">a</span> <span class="o">@</span> <span class="n">b</span>
<span class="g g-Whitespace">    </span><span class="mi">210</span> <span class="k">if</span> <span class="p">(</span>
<span class="ne">--&gt; </span><span class="mi">211</span>     <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">212</span>     <span class="ow">and</span> <span class="n">sparse</span><span class="o">.</span><span class="n">issparse</span><span class="p">(</span><span class="n">b</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">213</span>     <span class="ow">and</span> <span class="n">dense_output</span>
<span class="g g-Whitespace">    </span><span class="mi">214</span>     <span class="ow">and</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ret</span><span class="p">,</span> <span class="s2">&quot;toarray&quot;</span><span class="p">)</span>
<span class="g g-Whitespace">    </span><span class="mi">215</span> <span class="p">):</span>
<span class="g g-Whitespace">    </span><span class="mi">216</span>     <span class="k">return</span> <span class="n">ret</span><span class="o">.</span><span class="n">toarray</span><span class="p">()</span>
<span class="g g-Whitespace">    </span><span class="mi">217</span> <span class="k">return</span> <span class="n">ret</span>

<span class="nn">File ~/Library/Mobile Documents/com~apple~CloudDocs/Kurse/FDAML/.venv/lib/python3.12/site-packages/scipy/sparse/_base.py:1461,</span> in <span class="ni">issparse</span><span class="nt">(x)</span>
<span class="g g-Whitespace">   </span><span class="mi">1456</span>     <span class="k">pass</span>
<span class="g g-Whitespace">   </span><span class="mi">1458</span> <span class="n">sparray</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="n">_spbase</span><span class="o">.</span><span class="vm">__doc__</span>
<span class="ne">-&gt; </span><span class="mi">1461</span> <span class="k">def</span> <span class="nf">issparse</span><span class="p">(</span><span class="n">x</span><span class="p">):</span>
<span class="g g-Whitespace">   </span><span class="mi">1462</span><span class="w">     </span><span class="sd">&quot;&quot;&quot;Is `x` of a sparse array type?</span>
<span class="g g-Whitespace">   </span><span class="mi">1463</span><span class="sd"> </span>
<span class="g g-Whitespace">   </span><span class="mi">1464</span><span class="sd">     Parameters</span>
<span class="sd">   (...)</span>
<span class="g g-Whitespace">   </span><span class="mi">1485</span><span class="sd">     False</span>
<span class="g g-Whitespace">   </span><span class="mi">1486</span><span class="sd">     &quot;&quot;&quot;</span>
<span class="g g-Whitespace">   </span><span class="mi">1487</span>     <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">_spbase</span><span class="p">)</span>

<span class="ne">KeyboardInterrupt</span>: 
</pre></div>
</div>
</div>
</div>
<p>The cell below illustrates that the portfolio exhibit differences for the cluster portfolios.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">buy_and_hold_returns</span><span class="p">,</span> <span class="n">cluster_returns</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;Buy and hold&quot;</span><span class="p">},</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

<span class="n">monthly_strategy_returns</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;ME&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">monthly_strategy_returns</span> <span class="o">=</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m&quot;</span><span class="p">)</span>

<span class="n">monthly_strategy_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">monthly_strategy_results</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="s2">&quot;mean / std&quot;</span><span class="p">]</span>
<span class="n">monthly_strategy_results</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>mean / std</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Buy and hold</th>
      <td>0.0110</td>
      <td>0.0543</td>
      <td>0.2018</td>
    </tr>
    <tr>
      <th>cluster_pf_0</th>
      <td>0.0157</td>
      <td>0.0679</td>
      <td>0.2319</td>
    </tr>
    <tr>
      <th>cluster_pf_1</th>
      <td>0.0185</td>
      <td>0.0796</td>
      <td>0.2327</td>
    </tr>
    <tr>
      <th>cluster_pf_2</th>
      <td>0.0026</td>
      <td>0.0718</td>
      <td>0.0360</td>
    </tr>
    <tr>
      <th>cluster_pf_3</th>
      <td>0.0062</td>
      <td>0.0831</td>
      <td>0.0745</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">6</span><span class="p">))</span>
<span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">monthly_strategy_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/eea1973b1a20dd5b1c019a6bfdb5dd4e350295c619927e046d5fb1ff09f20ca8.png" src="_images/eea1973b1a20dd5b1c019a6bfdb5dd4e350295c619927e046d5fb1ff09f20ca8.png" />
</div>
</div>
<p>Taking a look at the Fama-French regressions (already for monthly data) for each portfolio in the cell below, we observe a risk-adjusted performance for cluster portfolio one which can not be fully explained by the Fama-French risk factors. According to the estimated beta coefficients, this portfolio reacts sensitive to the market and behaves like smaller value companies.</p>
<p>W.r.t the profitability of this portfolio, these results are quite promising. They exhibit that it is possible to create a portfolio for which we get an over-compensation for bearing systematic market risk. However, a few questions of this approach remain unanswered:</p>
<ul class="simple">
<li><p>What are the best choices regarding <span class="math notranslate nohighlight">\(k, c\)</span> and <span class="math notranslate nohighlight">\(n_{\text{assets}}\)</span>?</p></li>
<li><p>How can we make sure that companies are selected consistently, given the original random initialization of the clustering algorithm?</p></li>
<li><p>Which companies are selected in the most profitable clusters?</p></li>
</ul>
<p>We are not going to answer these questions here, but they highlight a problem which is often met, when working with machine learning algorithms - random initialization and explainability.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_monthly</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/ff_monthly.csv&quot;</span><span class="p">)</span>
<span class="n">ff_monthly</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ff_monthly</span><span class="o">.</span><span class="n">date</span>
<span class="n">ff_monthly</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">monthly_regression_data</span> <span class="o">=</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ff_monthly</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">portfolios</span> <span class="o">=</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="n">index_names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">portfolios</span><span class="p">:</span>
    <span class="n">index_names</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;estimates&quot;</span><span class="p">))</span>
    <span class="n">index_names</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;p_value&quot;</span><span class="p">))</span>

<span class="n">parameter_estimates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">index_names</span><span class="p">),</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_m&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_smb&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_hml&quot;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">pf_name</span> <span class="ow">in</span> <span class="n">portfolios</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">monthly_regression_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">pf_name</span><span class="p">]</span> <span class="o">-</span> <span class="n">monthly_regression_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;rf&quot;</span><span class="p">]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">monthly_regression_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;Mkt-RF&quot;</span><span class="p">,</span> <span class="s2">&quot;SMB&quot;</span><span class="p">,</span> <span class="s2">&quot;HML&quot;</span><span class="p">]]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cov_type</span><span class="o">=</span><span class="s2">&quot;HAC&quot;</span><span class="p">,</span> <span class="n">cov_kwds</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;maxlags&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">})</span> 
    <span class="n">parameter_estimates</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">pf_name</span><span class="p">,</span> <span class="s2">&quot;estimates&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">values</span>
    <span class="n">parameter_estimates</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">pf_name</span><span class="p">,</span> <span class="s2">&quot;p_value&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">pvalues</span><span class="o">.</span><span class="n">values</span>
    
<span class="n">parameter_estimates</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>alpha</th>
      <th>beta_m</th>
      <th>beta_smb</th>
      <th>beta_hml</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Buy and hold</th>
      <th>estimates</th>
      <td>0.000923</td>
      <td>0.996004</td>
      <td>0.263844</td>
      <td>0.295237</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.301719</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">cluster_pf_0</th>
      <th>estimates</th>
      <td>0.006161</td>
      <td>0.980574</td>
      <td>0.381065</td>
      <td>0.321404</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.136636</td>
      <td>0.0</td>
      <td>0.039513</td>
      <td>0.094571</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">cluster_pf_1</th>
      <th>estimates</th>
      <td>0.007925</td>
      <td>1.115315</td>
      <td>0.279374</td>
      <td>0.25461</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.061722</td>
      <td>0.0</td>
      <td>0.122779</td>
      <td>0.11641</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">cluster_pf_2</th>
      <th>estimates</th>
      <td>-0.007629</td>
      <td>1.016168</td>
      <td>0.031956</td>
      <td>0.674135</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.093524</td>
      <td>0.0</td>
      <td>0.884581</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">cluster_pf_3</th>
      <th>estimates</th>
      <td>-0.004908</td>
      <td>1.199243</td>
      <td>0.297735</td>
      <td>0.543843</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.378884</td>
      <td>0.0</td>
      <td>0.20327</td>
      <td>0.056605</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
</section>
<section id="cluster-portfolios-by-fama-french-factor-exposure">
<h3>Cluster portfolios by Fama-French factor exposure<a class="headerlink" href="#cluster-portfolios-by-fama-french-factor-exposure" title="Link to this heading">#</a></h3>
<p>When discussing factor models in the dependence chapter, we already learned about Fama-French’s factor model and how the corresponding beta parameters for the companies can be used to determine pairwise dependencies among companies. Furthermore, we know that companies with similar beta parameters tend to behave systematically similar w.r.t their value development. Thus, we aim to cluster companies according to their factor exposures (the beta parameters) and analyze if groups with different systematic behavior exhibit different development patterns over time. We proceed as follows:</p>
<ol class="arabic simple">
<li><p>Use daily data from the last <span class="math notranslate nohighlight">\(M\)</span> months to estimate factor exposure for every company to Fama-French factors <span class="math notranslate nohighlight">\(\mathbf{\beta}_i\)</span></p></li>
<li><p>Sort all companies into <span class="math notranslate nohighlight">\(c\)</span> clusters by using the beta vectors per company. To ensure cluster consistency, only initialize the cluster centers for the first estimation period randomly and use the cluster centers of the last estimation as starting values for the current period afterwards.</p></li>
<li><p>Hold these portfolio with equal weights for <span class="math notranslate nohighlight">\(H\)</span> months.</p></li>
</ol>
<p>The cell below proceeds as described using <span class="math notranslate nohighlight">\(M = 24\)</span>, <span class="math notranslate nohighlight">\(c = 3\)</span> and <span class="math notranslate nohighlight">\(H = 1\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">silhouette_samples</span>
<span class="kn">import</span> <span class="nn">seaborn</span> <span class="k">as</span> <span class="nn">sns</span>

<span class="n">estimation_period_in_months</span> <span class="o">=</span> <span class="mi">24</span>

<span class="n">month_starts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;2015-01-01&quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;2024-06-01&quot;</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="s2">&quot;MS&quot;</span><span class="p">)</span>
<span class="n">month_ends</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;2015-01-01&quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;2024-07-01&quot;</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="s2">&quot;ME&quot;</span><span class="p">)</span>

<span class="n">standardize_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">n_clusters</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">cluster_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">estimation_period_in_months</span><span class="p">]:,</span> <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cluster_pf_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">)])</span>
<span class="n">n_companies</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">month_starts</span><span class="p">[</span><span class="n">estimation_period_in_months</span><span class="p">:],</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cluster_pf_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">)])</span>
<span class="n">average_betas_per_cluster</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">([(</span><span class="n">dt</span><span class="p">,</span> <span class="n">c_num</span><span class="p">)</span> <span class="k">for</span> <span class="n">dt</span> <span class="ow">in</span> <span class="n">month_starts</span><span class="p">[</span><span class="mi">24</span><span class="p">:]</span> <span class="k">for</span> <span class="n">c_num</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">)],</span> <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;date&quot;</span><span class="p">,</span> <span class="s2">&quot;cluster&quot;</span><span class="p">]),</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Mkt-RF&quot;</span><span class="p">,</span> <span class="s2">&quot;SMB&quot;</span><span class="p">,</span> <span class="s2">&quot;HML&quot;</span><span class="p">])</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">estimation_period_in_months</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">month_starts</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">estimation_data</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="n">estimation_period_in_months</span><span class="p">]:</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span>
    <span class="n">holding_data</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">]:</span><span class="n">month_ends</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span>

    <span class="n">na_per_ticker</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">available_tickers</span> <span class="o">=</span> <span class="n">na_per_ticker</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">na_per_ticker</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">estimation_data</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">available_tickers</span><span class="p">]</span>
    <span class="n">holding_data</span> <span class="o">=</span> <span class="n">holding_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">available_tickers</span><span class="p">]</span>

    <span class="n">tickers</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">betas_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Mkt-RF&quot;</span><span class="p">,</span> <span class="s2">&quot;SMB&quot;</span><span class="p">,</span> <span class="s2">&quot;HML&quot;</span><span class="p">],</span> <span class="n">index</span> <span class="o">=</span> <span class="n">tickers</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
        <span class="n">regression_data_tmp</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="n">ticker</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">left_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">regression_data_tmp</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">ticker</span><span class="p">]</span> <span class="o">-</span> <span class="n">regression_data_tmp</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;rf&quot;</span><span class="p">]</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">regression_data_tmp</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;rf&quot;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

        <span class="n">betas_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ticker</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s2">&quot;Mkt-RF&quot;</span><span class="p">,</span> <span class="s2">&quot;SMB&quot;</span><span class="p">,</span> <span class="s2">&quot;HML&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">cluster_scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">cluster_data</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">betas_df</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">estimation_period_in_months</span><span class="p">:</span>
        <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cluster_center_init</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">cluster_centers_</span>
        <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">init</span> <span class="o">=</span> <span class="n">cluster_center_init</span><span class="p">)</span>

    <span class="n">kmeans</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cluster_data</span><span class="p">)</span>

    <span class="n">betas_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;cluster_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">labels_</span>
    <span class="n">average_betas_per_cluster</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">betas_df</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s2">&quot;cluster_labels&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>
    <span class="n">n_companies</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">betas_df</span><span class="o">.</span><span class="n">cluster_labels</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span><span class="o">.</span><span class="n">values</span>

    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">):</span>
        <span class="n">cluster_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">holding_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cluster_pf_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">holding_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">betas_df</span><span class="p">[</span><span class="n">betas_df</span><span class="o">.</span><span class="n">cluster_labels</span> <span class="o">==</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>The cell below documents differents in the risk-return behavior between the cluster portfolios which are formed by factor exposures. In our analysis, cluster 0 has the lowest average return but at the same time the smallest standard deviation implying the lowest risk .</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">buy_and_hold_returns</span><span class="p">,</span> <span class="n">cluster_returns</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;Buy and hold&quot;</span><span class="p">},</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

<span class="n">monthly_strategy_returns</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;ME&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">monthly_strategy_returns</span> <span class="o">=</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m&quot;</span><span class="p">)</span>

<span class="n">monthly_strategy_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">monthly_strategy_results</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="s2">&quot;mean / std&quot;</span><span class="p">]</span>
<span class="n">monthly_strategy_results</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>mean / std</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Buy and hold</th>
      <td>0.0110</td>
      <td>0.0543</td>
      <td>0.2018</td>
    </tr>
    <tr>
      <th>cluster_pf_0</th>
      <td>0.0097</td>
      <td>0.0395</td>
      <td>0.2460</td>
    </tr>
    <tr>
      <th>cluster_pf_1</th>
      <td>0.0139</td>
      <td>0.0639</td>
      <td>0.2172</td>
    </tr>
    <tr>
      <th>cluster_pf_2</th>
      <td>0.0113</td>
      <td>0.0955</td>
      <td>0.1189</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>Over time this does not lead to the highest growth in value, however to a more stable and steady growth process. The number of companies is also visualized over time in the right graphic of the figure below as a sanity check. However, with the exception of the beginning period, the number of companies per cluster portfolio are rather similar.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">monthly_strategy_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Cumulative returns for each portfolio&quot;</span><span class="p">)</span>
<span class="n">n_companies</span><span class="o">.</span><span class="n">dropna</span><span class="p">()</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Number of companies per cluster portfolio&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/852377340d26eef520701d71d77ff1c0bb9704a9e3c23f704202696a92607b2d.png" src="_images/852377340d26eef520701d71d77ff1c0bb9704a9e3c23f704202696a92607b2d.png" />
</div>
</div>
<p>In comparison to the clustering according to the loadings of principal components, we can use the average beta values of every cluster over time to better understand which type of companies are sorted into each cluster. The figure below exhibits that cluster 0 mostly includes companies with the least systematic exposure to the market and is rather neutral w.r.t size and value effects. In comparison, cluster 2 includes companies with the highest sensitivity towards market movments and companies which behave like small value stocks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">idx</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">IndexSlice</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">n_clusters</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sharey</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">):</span>
    <span class="n">cluster</span> <span class="o">=</span> <span class="n">average_betas_per_cluster</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">[:,</span> <span class="n">i</span><span class="p">],</span> <span class="p">:]</span>
    <span class="n">cluster</span> <span class="o">=</span> <span class="n">cluster</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">level</span> <span class="o">=</span> <span class="s2">&quot;cluster&quot;</span><span class="p">,</span> <span class="n">drop</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">cluster</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">title</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Average beta estimates for cluster </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/a22c7c6141c1f1d29c5db6a02ccaf5d78a196e0825879239ca627e00cd98bf52.png" src="_images/a22c7c6141c1f1d29c5db6a02ccaf5d78a196e0825879239ca627e00cd98bf52.png" />
</div>
</div>
<p>Conducting Fama-French regressions for these cluster portfolios confirms this as the market beta of cluster 0 is the least and the highest for cluster 2. The regression also reveals, that the performance of each cluster portfolio can be explained by Fama-French’s risk factors, as the constant is not statistically significant different from zero.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_monthly</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/ff_monthly.csv&quot;</span><span class="p">)</span>
<span class="n">ff_monthly</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ff_monthly</span><span class="o">.</span><span class="n">date</span>
<span class="n">ff_monthly</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">monthly_regression_data</span> <span class="o">=</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ff_monthly</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">portfolios</span> <span class="o">=</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="n">index_names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">portfolios</span><span class="p">:</span>
    <span class="n">index_names</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;estimates&quot;</span><span class="p">))</span>
    <span class="n">index_names</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;p_value&quot;</span><span class="p">))</span>

<span class="n">parameter_estimates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">index_names</span><span class="p">),</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_m&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_smb&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_hml&quot;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">pf_name</span> <span class="ow">in</span> <span class="n">portfolios</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">monthly_regression_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">pf_name</span><span class="p">]</span> <span class="o">-</span> <span class="n">monthly_regression_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;rf&quot;</span><span class="p">]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">monthly_regression_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;Mkt-RF&quot;</span><span class="p">,</span> <span class="s2">&quot;SMB&quot;</span><span class="p">,</span> <span class="s2">&quot;HML&quot;</span><span class="p">]]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cov_type</span><span class="o">=</span><span class="s2">&quot;HAC&quot;</span><span class="p">,</span> <span class="n">cov_kwds</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;maxlags&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">})</span> 
    <span class="n">parameter_estimates</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">pf_name</span><span class="p">,</span> <span class="s2">&quot;estimates&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">values</span>
    <span class="n">parameter_estimates</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">pf_name</span><span class="p">,</span> <span class="s2">&quot;p_value&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">pvalues</span><span class="o">.</span><span class="n">values</span>
    
<span class="n">parameter_estimates</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>alpha</th>
      <th>beta_m</th>
      <th>beta_smb</th>
      <th>beta_hml</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Buy and hold</th>
      <th>estimates</th>
      <td>0.000923</td>
      <td>0.996004</td>
      <td>0.263844</td>
      <td>0.295237</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.301719</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">cluster_pf_0</th>
      <th>estimates</th>
      <td>0.00078</td>
      <td>0.738491</td>
      <td>-0.179752</td>
      <td>0.14623</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.635724</td>
      <td>0.0</td>
      <td>0.005035</td>
      <td>0.002793</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">cluster_pf_1</th>
      <th>estimates</th>
      <td>0.000963</td>
      <td>1.187988</td>
      <td>0.35124</td>
      <td>-0.034004</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.535001</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.540548</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">cluster_pf_2</th>
      <th>estimates</th>
      <td>0.000749</td>
      <td>1.40003</td>
      <td>0.848084</td>
      <td>0.95346</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.831002</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<p>As a last analysis, we aim to improve the performance of beta clustered portfolios. From the discussion of factor based estimation of the covariance matrix, we know that portfolios with a high level of systematic diversification may be achieved by selecting companies with dissimilar beta vectors. This is why for every clustered beta portfolio we do the following.</p>
<ol class="arabic simple">
<li><p>For every cluster, we determine the ratio of the mean and standard deviation for companies in the cluster and select the one with the highest ratio. This company is included into the cluster specific low diversification portfolio.</p></li>
<li><p>Select the companies within this cluster with the highest dissimilarity of the beta vectors; dissimilarity is quantified by <span class="math notranslate nohighlight">\(1 - \text{cos}(\boldsymbol{\beta}_i, \boldsymbol{\beta}_j)\)</span>; if more than one company is already in the cluster specific portfolio, select the company with the highest average dissimilarity to the current companies. Repeat this process until <span class="math notranslate nohighlight">\(n_{\text{assets}}\)</span> are included into the cluster specific portfolio.</p></li>
<li><p>Hold an equally weighted for every cluster specific portfolio for a holding period of <span class="math notranslate nohighlight">\(H\)</span> month.</p></li>
</ol>
<p>The example uses <span class="math notranslate nohighlight">\(M = 24\)</span>, <span class="math notranslate nohighlight">\(c = 3\)</span>, <span class="math notranslate nohighlight">\(H = 1\)</span> and <span class="math notranslate nohighlight">\(n_{\text{assets}} = 10\)</span></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sklearn.metrics.pairwise</span> <span class="kn">import</span> <span class="n">cosine_distances</span>
<span class="kn">from</span> <span class="nn">sklearn.preprocessing</span> <span class="kn">import</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>

<span class="n">estimation_period_in_months</span> <span class="o">=</span> <span class="mi">24</span>

<span class="n">month_starts</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;2015-01-01&quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;2024-06-01&quot;</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="s2">&quot;MS&quot;</span><span class="p">)</span>
<span class="n">month_ends</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">start</span> <span class="o">=</span> <span class="s2">&quot;2015-01-01&quot;</span><span class="p">,</span> <span class="n">end</span> <span class="o">=</span> <span class="s2">&quot;2024-07-01&quot;</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="s2">&quot;ME&quot;</span><span class="p">)</span>

<span class="n">standardize_data</span> <span class="o">=</span> <span class="kc">True</span>
<span class="n">n_clusters</span> <span class="o">=</span> <span class="mi">3</span>
<span class="n">n_companies_pf</span> <span class="o">=</span> <span class="mi">10</span>

<span class="n">cluster_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">estimation_period_in_months</span><span class="p">]:,</span> <span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cluster_pf_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">)])</span>
<span class="n">companies_in_pf</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">month_starts</span><span class="p">[</span><span class="n">estimation_period_in_months</span><span class="p">:],</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;cluster_pf_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">)])</span>

<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">estimation_period_in_months</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">month_starts</span><span class="p">),</span> <span class="mi">1</span><span class="p">):</span>
    <span class="n">estimation_data</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="o">-</span><span class="n">estimation_period_in_months</span><span class="p">]:</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span>
    <span class="n">holding_data</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">]:</span><span class="n">month_ends</span><span class="p">[</span><span class="n">t</span><span class="p">]]</span>

    <span class="n">na_per_ticker</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
    <span class="n">available_tickers</span> <span class="o">=</span> <span class="n">na_per_ticker</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">na_per_ticker</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">estimation_data</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">available_tickers</span><span class="p">]</span>
    <span class="n">holding_data</span> <span class="o">=</span> <span class="n">holding_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">available_tickers</span><span class="p">]</span>

    <span class="n">tickers</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
    <span class="n">betas_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;Mkt-RF&quot;</span><span class="p">,</span> <span class="s2">&quot;SMB&quot;</span><span class="p">,</span> <span class="s2">&quot;HML&quot;</span><span class="p">],</span> <span class="n">index</span> <span class="o">=</span> <span class="n">tickers</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ticker</span> <span class="ow">in</span> <span class="n">tickers</span><span class="p">:</span>
        <span class="n">regression_data_tmp</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="n">ticker</span><span class="p">]]</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ff</span><span class="p">,</span> <span class="n">left_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">regression_data_tmp</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">ticker</span><span class="p">]</span> <span class="o">-</span> <span class="n">regression_data_tmp</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;rf&quot;</span><span class="p">]</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">regression_data_tmp</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">ticker</span><span class="p">,</span> <span class="s2">&quot;rf&quot;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">()</span>

        <span class="n">betas_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">ticker</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">loc</span><span class="p">[[</span><span class="s2">&quot;Mkt-RF&quot;</span><span class="p">,</span> <span class="s2">&quot;SMB&quot;</span><span class="p">,</span> <span class="s2">&quot;HML&quot;</span><span class="p">]]</span><span class="o">.</span><span class="n">values</span>

    <span class="n">cluster_scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
    <span class="n">cluster_data</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">betas_df</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">t</span> <span class="o">==</span> <span class="n">estimation_period_in_months</span><span class="p">:</span>
        <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">random_state</span> <span class="o">=</span> <span class="mi">42</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">cluster_center_init</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">cluster_centers_</span>
        <span class="n">kmeans</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="n">n_clusters</span><span class="p">,</span> <span class="n">init</span> <span class="o">=</span> <span class="n">cluster_center_init</span><span class="p">)</span>

    <span class="n">kmeans</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cluster_data</span><span class="p">)</span>

    <span class="n">betas_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;cluster_labels&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">kmeans</span><span class="o">.</span><span class="n">labels_</span>
    <span class="n">n_companies_per_cluster</span> <span class="o">=</span> <span class="n">betas_df</span><span class="o">.</span><span class="n">cluster_labels</span><span class="o">.</span><span class="n">value_counts</span><span class="p">()</span>
    <span class="n">pf_sizes</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">):</span>
        <span class="n">cluster_pf_size</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">n_companies_per_cluster</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">n_companies_pf</span><span class="p">)</span>
        <span class="n">pf_sizes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">cluster_pf_size</span>
        <span class="k">if</span> <span class="n">cluster_pf_size</span> <span class="o">&lt;</span> <span class="n">n_companies_pf</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Number of companies in portfolio for cluster </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2"> from </span><span class="si">{</span><span class="n">estimation_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2"> to </span><span class="si">{</span><span class="n">estimation_data</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> is </span><span class="si">{</span><span class="n">cluster_pf_size</span><span class="si">}</span><span class="s2"> instead of </span><span class="si">{</span><span class="n">n_companies_pf</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">betas_df_cluster</span> <span class="o">=</span> <span class="n">betas_df</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;cluster_labels == </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">cluster_companies</span> <span class="o">=</span> <span class="n">betas_df_cluster</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

        <span class="n">pf_companies</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">cluster_companies_returns</span> <span class="o">=</span> <span class="n">estimation_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">cluster_companies</span><span class="p">]</span>
        <span class="n">cluster_companies_performance</span> <span class="o">=</span> <span class="n">cluster_companies_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">cluster_companies_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">cluster_pf_size</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">j</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">add_company</span> <span class="o">=</span> <span class="n">cluster_companies_performance</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">cluster_companies_performance</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]</span>
                <span class="n">pf_companies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add_company</span><span class="p">)</span>
                <span class="n">current_pf_company_betas</span> <span class="o">=</span> <span class="n">betas_df_cluster</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pf_companies</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">remaining_cluster_companies</span> <span class="o">=</span> <span class="n">betas_df_cluster</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">pf_companies</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">distances</span> <span class="o">=</span> <span class="n">cosine_distances</span><span class="p">(</span><span class="n">current_pf_company_betas</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">],</span> <span class="n">remaining_cluster_companies</span><span class="o">.</span><span class="n">values</span><span class="p">[:,</span> <span class="p">:</span><span class="mi">3</span><span class="p">])</span>
                <span class="n">add_company</span> <span class="o">=</span> <span class="n">remaining_cluster_companies</span><span class="o">.</span><span class="n">index</span><span class="p">[</span><span class="n">distances</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">0</span><span class="p">)</span><span class="o">.</span><span class="n">argmax</span><span class="p">()]</span>

                <span class="n">pf_companies</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">add_company</span><span class="p">)</span>
                <span class="n">current_pf_company_betas</span> <span class="o">=</span> <span class="n">betas_df_cluster</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">pf_companies</span><span class="p">,</span> <span class="p">:]</span>
                <span class="n">remaining_cluster_companies</span> <span class="o">=</span> <span class="n">betas_df_cluster</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">pf_companies</span><span class="p">)</span>
        
        <span class="n">cluster_returns</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">holding_data</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;cluster_pf_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">holding_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">pf_companies</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">companies_in_pf</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">month_starts</span><span class="p">[</span><span class="n">t</span><span class="p">],</span> <span class="sa">f</span><span class="s2">&quot;cluster_pf_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pf_companies</span>
</pre></div>
</div>
</div>
</div>
<p>In comparison to the full cluster portfolios, the performance improves for reduced cluster portfolio 0 and 1 and worsens for reduced cluster portfolio 2.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">buy_and_hold_returns</span><span class="p">,</span> <span class="n">cluster_returns</span><span class="p">),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">rename</span><span class="p">({</span><span class="mi">0</span><span class="p">:</span> <span class="s2">&quot;Buy and hold&quot;</span><span class="p">},</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">strategy_returns</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">float</span><span class="p">)</span>

<span class="n">monthly_strategy_returns</span> <span class="o">=</span> <span class="n">strategy_returns</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">x</span><span class="p">))</span><span class="o">.</span><span class="n">resample</span><span class="p">(</span><span class="s2">&quot;ME&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
<span class="n">monthly_strategy_returns</span> <span class="o">=</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
<span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y-%m&quot;</span><span class="p">)</span>

<span class="n">monthly_strategy_results</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">((</span><span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">(),</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">std</span><span class="p">(),</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span> <span class="o">/</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">std</span><span class="p">()),</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">)</span>
<span class="n">monthly_strategy_results</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;mean&quot;</span><span class="p">,</span> <span class="s2">&quot;std&quot;</span><span class="p">,</span> <span class="s2">&quot;mean / std&quot;</span><span class="p">]</span>
<span class="n">monthly_strategy_results</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>mean</th>
      <th>std</th>
      <th>mean / std</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>Buy and hold</th>
      <td>0.0110</td>
      <td>0.0543</td>
      <td>0.2018</td>
    </tr>
    <tr>
      <th>cluster_pf_0</th>
      <td>0.0119</td>
      <td>0.0460</td>
      <td>0.2588</td>
    </tr>
    <tr>
      <th>cluster_pf_1</th>
      <td>0.0200</td>
      <td>0.0837</td>
      <td>0.2390</td>
    </tr>
    <tr>
      <th>cluster_pf_2</th>
      <td>0.0025</td>
      <td>0.1018</td>
      <td>0.0246</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">matplotlib.pylab</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
<span class="p">((</span><span class="mi">1</span> <span class="o">+</span> <span class="n">monthly_strategy_returns</span><span class="p">)</span><span class="o">.</span><span class="n">cumprod</span><span class="p">()</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">,</span> <span class="n">title</span> <span class="o">=</span> <span class="s2">&quot;Cumulative returns for each portfolio&quot;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7ce1570e0b4fdc96aa0b175ce916f67d110fb79244cddb52f7d32c07e83b3096.png" src="_images/7ce1570e0b4fdc96aa0b175ce916f67d110fb79244cddb52f7d32c07e83b3096.png" />
</div>
</div>
<p>However, the risk adjusted performance of the reduced cluster portfolio 0 is now statistically different from zero at a significance level of 5%. This is rather spectacular as it means that investors of this portfolio get an extra compensation for holding a less systematic risky portfolio. Such a finding might only be explained that the market participants are not aware of these systematic diversification.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">ff_monthly</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="s2">&quot;../data/ff_monthly.csv&quot;</span><span class="p">)</span>
<span class="n">ff_monthly</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">ff_monthly</span><span class="o">.</span><span class="n">date</span>
<span class="n">ff_monthly</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="s2">&quot;date&quot;</span><span class="p">],</span> <span class="n">axis</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span> <span class="n">inplace</span> <span class="o">=</span> <span class="kc">True</span><span class="p">)</span>

<span class="n">monthly_regression_data</span> <span class="o">=</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">ff_monthly</span><span class="p">,</span> <span class="n">left_index</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">right_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">portfolios</span> <span class="o">=</span> <span class="n">monthly_strategy_returns</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>

<span class="n">index_names</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">portfolios</span><span class="p">:</span>
    <span class="n">index_names</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;estimates&quot;</span><span class="p">))</span>
    <span class="n">index_names</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;p_value&quot;</span><span class="p">))</span>

<span class="n">parameter_estimates</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">index</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">MultiIndex</span><span class="o">.</span><span class="n">from_tuples</span><span class="p">(</span><span class="n">index_names</span><span class="p">),</span> <span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;alpha&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_m&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_smb&quot;</span><span class="p">,</span> <span class="s2">&quot;beta_hml&quot;</span><span class="p">])</span>
<span class="k">for</span> <span class="n">pf_name</span> <span class="ow">in</span> <span class="n">portfolios</span><span class="p">:</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">monthly_regression_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="n">pf_name</span><span class="p">]</span> <span class="o">-</span> <span class="n">monthly_regression_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="s2">&quot;rf&quot;</span><span class="p">]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">monthly_regression_data</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="p">[</span><span class="s2">&quot;Mkt-RF&quot;</span><span class="p">,</span> <span class="s2">&quot;SMB&quot;</span><span class="p">,</span> <span class="s2">&quot;HML&quot;</span><span class="p">]]</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">add_constant</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

    <span class="n">model</span> <span class="o">=</span> <span class="n">sm</span><span class="o">.</span><span class="n">OLS</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">X</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">cov_type</span><span class="o">=</span><span class="s2">&quot;HAC&quot;</span><span class="p">,</span> <span class="n">cov_kwds</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;maxlags&quot;</span><span class="p">:</span> <span class="mi">6</span><span class="p">})</span> 
    <span class="n">parameter_estimates</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">pf_name</span><span class="p">,</span> <span class="s2">&quot;estimates&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">values</span>
    <span class="n">parameter_estimates</span><span class="o">.</span><span class="n">loc</span><span class="p">[(</span><span class="n">pf_name</span><span class="p">,</span> <span class="s2">&quot;p_value&quot;</span><span class="p">)]</span> <span class="o">=</span> <span class="n">results</span><span class="o">.</span><span class="n">pvalues</span><span class="o">.</span><span class="n">values</span>
    
<span class="n">parameter_estimates</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th></th>
      <th>alpha</th>
      <th>beta_m</th>
      <th>beta_smb</th>
      <th>beta_hml</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th rowspan="2" valign="top">Buy and hold</th>
      <th>estimates</th>
      <td>0.000923</td>
      <td>0.996004</td>
      <td>0.263844</td>
      <td>0.295237</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.301719</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">cluster_pf_0</th>
      <th>estimates</th>
      <td>0.008861</td>
      <td>0.268308</td>
      <td>0.325422</td>
      <td>0.228994</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.028225</td>
      <td>0.060438</td>
      <td>0.020132</td>
      <td>0.04164</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">cluster_pf_1</th>
      <th>estimates</th>
      <td>0.005929</td>
      <td>1.213557</td>
      <td>0.653899</td>
      <td>-0.263832</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.268619</td>
      <td>0.0</td>
      <td>0.000133</td>
      <td>0.052056</td>
    </tr>
    <tr>
      <th rowspan="2" valign="top">cluster_pf_2</th>
      <th>estimates</th>
      <td>-0.005838</td>
      <td>1.200437</td>
      <td>1.364994</td>
      <td>0.728607</td>
    </tr>
    <tr>
      <th>p_value</th>
      <td>0.355088</td>
      <td>0.0</td>
      <td>0.0</td>
      <td>0.0</td>
    </tr>
  </tbody>
</table>
</div></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">figsize</span> <span class="o">=</span> <span class="p">(</span><span class="mi">10</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">*</span> <span class="mi">4</span><span class="p">))</span>


<span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">n_clusters</span><span class="p">):</span>
    <span class="n">all_tickers</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="n">index</span> <span class="o">=</span> <span class="n">month_starts</span><span class="p">[</span><span class="n">estimation_period_in_months</span><span class="p">:],</span> <span class="n">columns</span> <span class="o">=</span> <span class="n">study_returns</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">tolist</span><span class="p">())</span>
    <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">companies_in_pf</span><span class="o">.</span><span class="n">index</span><span class="p">,</span> <span class="n">companies_in_pf</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="sa">f</span><span class="s2">&quot;cluster_pf_</span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]):</span>
        <span class="n">all_tickers</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">row</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">sns</span><span class="o">.</span><span class="n">heatmap</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">all_tickers</span> <span class="o">==</span> <span class="kc">True</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">cmap</span> <span class="o">=</span> <span class="s2">&quot;viridis&quot;</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">])</span>

    <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">month_starts</span><span class="p">[</span><span class="n">estimation_period_in_months</span><span class="p">:])</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">set_yticklabels</span><span class="p">([</span><span class="n">dt</span><span class="o">.</span><span class="n">date</span><span class="p">()</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">dt</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">month_starts</span><span class="p">[</span><span class="n">estimation_period_in_months</span><span class="p">:])</span> <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">(</span><span class="n">x_tick_idx</span><span class="p">)</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">set_xticklabels</span><span class="p">([</span><span class="n">study_returns</span><span class="o">.</span><span class="n">columns</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">x_tick_idx</span><span class="p">])</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">c</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Cluster </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2"> beta dissimilarity portfolio&quot;</span><span class="p">)</span>

<span class="n">fig</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">show</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="_images/7d138953343965e5977526a78dbf53a8b1098fb0e9b33b2ff8082676d4438754.png" src="_images/7d138953343965e5977526a78dbf53a8b1098fb0e9b33b2ff8082676d4438754.png" />
</div>
</div>
</section>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            name: "python3",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="05_machine_learning.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Machine learning</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prediction-of-asset-risk-premiums">Prediction of asset risk premiums</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#specifics">Specifics</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#results">Results</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#building-your-own-machine-learning-models-for-asset-price-prediction">Building your own machine learning models for asset price prediction</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#understanding-and-using-pca-loadings-for-asset-return-data">Understanding and using PCA loadings for asset return data</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cluster-portfolios-by-pca-loadings">Cluster portfolios by pca loadings</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#cluster-portfolios-by-fama-french-factor-exposure">Cluster portfolios by Fama-French factor exposure</a></li>
</ul>
</li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By Prof. Dr. Ralf Kellner
</p>

  </div>
  
  <div class="footer-item">
    

  <p class="copyright">
    
      © Copyright 2023.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>